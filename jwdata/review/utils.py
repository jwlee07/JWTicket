from django.db.models import Avg, Count, F, Min
from django.db.models.functions import Cast, Concat, Length
from django.db.models import CharField, Value
from datetime import date, timedelta
from collections import Counter, defaultdict
from konlpy.tag import Okt
import re
import io
import base64
import matplotlib.pyplot as plt

# 불용어 목록
stop_words = [
    # 일반적인 불용어
    '이', '그', '저', '것', '이것', '그것', '저것', '이번', '그번', '저번',
    '이거', '그거', '저거', '요', '는', '을', '를', '이', '가', '에', '의',
    '으로', '로', '에서', '도', '만', '은', '는', '이다', '있다', '하다', '이다',
    '된다', '안', '못', '할', '없다', '있다', '없다', '때문', '거', '수', '듯',
    '등', '들', '더', '대한', '한', '줄', '말', '좀', '많이', '많은', '보다',
    '통해', '위해', '으로', '에서', '부터', '까지', '에게', '처럼', '만큼', '같이',
    '함께', '따라', '있는', '하는', '한', '때', '중', '후', '전', '또', '또한',
    '그리고', '그래서', '하지만', '그런데', '그러나', '그러면', '그렇게', '이렇게',
    '저렇게', '어떻게', '왜', '어디', '언제', '누가', '누구', '무엇', '무슨', '어느',
    '어떤', '몇', '얼마', '이런', '그런', '저런', '이런', '그런', '저런',
    
    # 공연 관련 불용어
    '공연', '연극', '뮤지컬', '콘서트', '배우', '관람', '극장', '무대', '작품',
    '티켓', '좌석', '예매', '관객', '연출', '대사', '노래', '연기', '연주',
    '출연', '주연', '조연', '캐스팅', '감독', '극작가', '작가', '작곡가', '감상',
    '후기', '리뷰', '평점', '평가', '감상평', '추천', '비추천', '별점', '점수',
    
    # 감정 관련 불용어
    '좋다', '좋아요', '좋았다', '좋았어요', '좋았습니다', '좋네요', '좋은',
    '나쁘다', '나빠요', '나빴다', '나빴어요', '나빴습니다', '나쁜',
    '재미있다', '재미있어요', '재미있었다', '재미있었어요', '재미있었습니다',
    '재미없다', '재미없어요', '재미없었다', '재미없었어요', '재미없었습니다',
    '최고', '최고다', '최고예요', '최고였다', '최고였어요', '최고였습니다',
    '최악', '최악이다', '최악이에요', '최악이었다', '최악이었어요', '최악이었습니다',
    '실망이다', '실망스럽다', '아쉽다', '아쉬워요', '별로다', '별로예요', '그냥저냥',
    
    # 기타 자주 등장하는 불필요한 단어
    '사람', '생각', '느낌', '때문', '같은', '같다', '이런', '저런', '어떤', '이번',
    '저번', '다음', '지금', '요즘', '올해', '작년', '이상', '이하', '앞', '뒤',
    '위', '아래', '중', '내내', '제가', '저는', '나는', '우리', '오늘', '어제',
    '하나', '둘', '셋', '첫', '두', '세', '네', '다섯', '이게', '그게', '저게',
    '뭔가', '어떻게', '어찌', '이렇게', '그렇게', '저렇게', '이래', '그래', '저래',
    '이와', '그와', '저와', '이런', '그런', '저런'
]

def clean_text(text):
    cleaned = re.sub(r"[^가-힣a-zA-Z0-9\s]", "", text)
    cleaned = re.sub(r"\s+", " ", cleaned).strip()
    return cleaned

def preprocess_text(texts):
    okt = Okt()

    # 최종 토큰을 모을 리스트
    all_nouns = []

    for doc in texts:
        # 원본 텍스트에서 특수문자 제거 + 여백 정리
        cleaned = clean_text(doc)

        # 명사만 추출
        nouns = okt.nouns(cleaned)
        nouns = [n for n in nouns if n not in stop_words]

        # 전체 리스트에 추가
        all_nouns.extend(nouns)

    # 추출된 모든 명사를 공백으로 join
    final_text = " ".join(all_nouns)
    return final_text

def comma_format(num):
    if not num:
        return "0"
    return f"{num:,}" 