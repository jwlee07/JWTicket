{% extends "review/base.html" %}

{% block content %}
<div class="content-container mt-5">
    <h1 class="text-center">전체 공연 리뷰 통합 보기</h1>

    <!-- 기간 지정 -->
    <h2 class="mt-4">기간 지정</h2>
    <form method="GET" action="{% url 'analyze_all_reviews' %}">
        <div class="row">
            <div class="col">
                <label for="start_date">시작일</label>
                <input type="date" id="start_date" name="start_date" class="form-control" value="{{ start_date }}">
            </div>
            <div class="col">
                <label for="end_date">종료일</label>
                <input type="date" id="end_date" name="end_date" class="form-control" value="{{ end_date }}">
            </div>
            <div class="col-auto d-flex align-items-end">
                <button type="submit" class="btn btn-dark">필터 적용</button>
            </div>
        </div>
    </form>

    <!-- 공연별 요약 -->
    {% if concert_summary %}
    <h2 class="mt-4">공연별 요약</h2>
    <table class="table table-bordered table-hover mt-3">
        <thead class="table-dark">
            <tr>
                <th>공연명</th>
                <th>장소</th>
                <th>평균 평점</th>
                <th>총 리뷰 수</th>
            </tr>
        </thead>
        <tbody>
            {% for concert in concert_summary %}
            <tr>
                <td>{{ concert.concert__name }}</td>
                <td>{{ concert.concert__place }}</td>
                <td>{{ concert.average_rating|floatformat:1 }}/5</td>
                <td>{{ concert.total_reviews }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% endif %}

    <!-- 공연별 리뷰 수 -->
    {% if concert_date_summary %}
    <h2 class="mt-4">공연별 리뷰 수</h2>
    <canvas id="reviewChart" width="100%" height="50"></canvas>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const ctx = document.getElementById('reviewChart').getContext('2d');

            const datasets = [
                {% for concert_name, date_summary in concert_date_summary.items %}
                {
                    label: '{{ concert_name }}',
                    data: [
                        {% for date in date_summary %}
                        { x: '{{ date.date|date:"Y-m-d" }}', y: {{ date.reviews_count }} },
                        {% endfor %}
                    ],
                    borderColor: 
                        {% if concert_name == "뮤지컬 〈긴긴밤〉" %}
                        'rgba(104, 185, 157, 1)'
                        {% elif concert_name == "뮤지컬 〈테일러〉" %}
                        'rgba(0, 6, 6, 1)'
                        {% elif concert_name == "연극 ＇타인의 삶＇" %}
                        'rgba(195, 32, 31, 1)'
                        {% else %}
                        'rgba(192, 192, 192, 1)'
                        {% endif %},
                    backgroundColor: 
                        {% if concert_name == "뮤지컬 〈긴긴밤〉" %}
                        'rgba(104, 185, 157, 0.2)'
                        {% elif concert_name == "뮤지컬 〈테일러〉" %}
                        'rgba(0, 6, 6, 0.2)'
                        {% elif concert_name == "연극 ＇타인의 삶＇" %}
                        'rgba(195, 32, 31, 0.2)'
                        {% else %}
                        'rgba(192, 192, 192, 0.2)'
                        {% endif %},
                    borderWidth: 2,
                    tension: 0.2,
                    fill: false,
                },
                {% endfor %}
            ];

            new Chart(ctx, {
                type: 'line',
                data: { datasets: datasets },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: true, position: 'top' },
                    },
                    scales: {
                        x: {
                            type: 'time',
                            time: {
                                unit: 'day',
                                tooltipFormat: 'MM월 DD일(ddd)',
                                displayFormats: { day: 'MM월 DD일(ddd)' },
                            },
                            title: {
                                display: true,
                                text: '날짜',
                                font: { weight: 'bold', size: 14 },
                            },
                        },
                        y: {
                            title: {
                                display: true,
                                text: '리뷰 수',
                                font: { weight: 'bold', size: 14 },
                            },
                            beginAtZero: true,
                        },
                    },
                },
            });
        });
    </script>
    {% endif %}

    <!-- 공연별 평균 평점 -->
    {% if concert_date_rating_summary %}
    <h2 class="mt-4">공연별 평균 평점(5점 만점)</h2>
    <canvas id="ratingChart" width="100%" height="50"></canvas>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const ctxRating = document.getElementById('ratingChart').getContext('2d');

            const ratingDatasets = [
                {% for concert_name, date_rating_summary in concert_date_rating_summary.items %}
                {
                    label: '{{ concert_name }}',
                    data: [
                        {% for date in date_rating_summary %}
                        { x: '{{ date.date|date:"Y-m-d" }}', y: {{ date.average_rating|floatformat:1 }} },
                        {% endfor %}
                    ],
                    borderColor: 
                        {% if concert_name == "뮤지컬 〈긴긴밤〉" %}
                        'rgba(104, 185, 157, 1)'
                        {% elif concert_name == "뮤지컬 〈테일러〉" %}
                        'rgba(0, 6, 6, 1)'
                        {% elif concert_name == "연극 ＇타인의 삶＇" %}
                        'rgba(195, 32, 31, 1)'
                        {% else %}
                        'rgba(192, 192, 192, 1)'
                        {% endif %},
                    backgroundColor: 
                        {% if concert_name == "뮤지컬 〈긴긴밤〉" %}
                        'rgba(104, 185, 157, 0.2)'
                        {% elif concert_name == "뮤지컬 〈테일러〉" %}
                        'rgba(0, 6, 6, 0.2)'
                        {% elif concert_name == "연극 ＇타인의 삶＇" %}
                        'rgba(195, 32, 31, 0.2)'
                        {% else %}
                        'rgba(192, 192, 192, 0.2)'
                        {% endif %},
                    borderWidth: 2,
                    tension: 0.2,
                    fill: false,
                },
                {% endfor %}
            ];

            new Chart(ctxRating, {
                type: 'line',
                data: { datasets: ratingDatasets },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: true, position: 'top' },
                    },
                    scales: {
                        x: {
                            type: 'time',
                            time: {
                                unit: 'day',
                                tooltipFormat: 'MM월 DD일(ddd)',
                                displayFormats: { day: 'MM월 DD일(ddd)' },
                            },
                            title: {
                                display: true,
                                text: '날짜',
                                font: { weight: 'bold', size: 14 },
                            },
                        },
                        y: {
                            title: {
                                display: true,
                                text: '평균 평점',
                                font: { weight: 'bold', size: 14 },
                            },
                            beginAtZero: true,
                            max: 6,
                        },
                    },
                },
            });
        });
    </script>
    {% endif %}
    
    {% if combination_counts %}
    <h2 class="mt-4">공연 조합별 관객 분포</h2>
    <canvas id="combinationChart" style="max-width: 100%; max-height: 500px;"></canvas>
    {% else %}
    <p class="text-muted">공연 조합별 닉네임 데이터가 없습니다.</p>
    {% endif %}    
    {% if common_nicknames %}
    <h2 class="mt-4">닉네임 별 관람 공연</h2>
    <table class="table table-bordered table-hover mt-4">
        <thead class="table-dark">
            <tr>
                <th>닉네임</th>
                <th>관련 공연</th>
                <th>관련 공연 수</th>
            </tr>
        </thead>
        <tbody>
            {% for nickname, concerts in common_nicknames.items %}
            <tr>
                <td>{{ nickname }}</td>
                <td>{{ concerts|join:", " }}</td>
                <td>{{ concerts|length }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <p class="text-muted">닉네임 별 관람 공연이 없습니다.</p>
    {% endif %}

    <!-- 모든 리뷰 최신순 출력 -->
    {% if reviews %}
    <h2 class="mt-4">전체 리뷰</h2>
    <table class="table table-bordered table-hover mt-3">
        <thead class="table-dark">
            <tr>
                <th style="white-space: nowrap;">공연명</th>
                <th style="white-space: nowrap;">장소</th>
                <th style="white-space: nowrap;">작성자</th>
                <th style="white-space: nowrap;">작성일</th>
                <th style="white-space: nowrap;">평점</th>
                <th style="white-space: nowrap;">제목</th>
                <th style="white-space: nowrap;">내용</th>
                <th style="white-space: nowrap;">조회수</th>
                <th style="white-space: nowrap;">좋아요</th>
            </tr>
        </thead>
        <tbody>
            {% for review in reviews|dictsortreversed:"작성일" %}
            <tr>
                <td style="white-space: nowrap;">{{ review.공연명 }}</td>
                <td style="white-space: nowrap;">{{ review.장소 }}</td>
                <td>{{ review.작성자 }}</td>
                <td style="white-space: nowrap;">{{ review.작성일 }}</td>
                <td>{{ review.평점 }}/5</td>
                <td>{{ review.제목 }}</td>
                <td>{{ review.내용 }}</td>
                <td>{{ review.조회수 }}</td>
                <td>{{ review.좋아요 }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <p class="text-center text-muted mt-5">등록된 리뷰가 없습니다.</p>
    {% endif %}
</div>
{% endblock content %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/moment"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-moment"></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const ctx = document.getElementById('combinationChart').getContext('2d');

        // 공연별 색상 정의
        const colors = {
            "뮤지컬 〈긴긴밤〉": {
                border: 'rgba(104, 185, 157, 1)',
                background: 'rgba(104, 185, 157, 0.2)'
            },
            "뮤지컬 〈테일러〉": {
                border: 'rgba(0, 6, 6, 1)',
                background: 'rgba(0, 6, 6, 0.2)'
            },
            "연극 ＇타인의 삶＇": {
                border: 'rgba(195, 32, 31, 1)',
                background: 'rgba(195, 32, 31, 0.2)'
            },
            "기타": {
                border: 'rgba(192, 192, 192, 1)',
                background: 'rgba(192, 192, 192, 0.2)'
            }
        };

        // 겹치는 공연의 경우 색상 조합 생성
        const generateMixedColor = (combo, type) => {
            const individualColors = combo.split(", ").map(name => (colors[name.trim()] || colors["기타"])[type]);
            const mixedColor = individualColors.reduce((acc, color) => {
                const rgba = color.match(/\d+/g).map(Number);
                acc[0] += rgba[0];
                acc[1] += rgba[1];
                acc[2] += rgba[2];
                acc[3] += rgba[3] || 1;
                return acc;
            }, [0, 0, 0, 0]).map(value => value / individualColors.length);
            return `rgba(${mixedColor[0]}, ${mixedColor[1]}, ${mixedColor[2]}, ${mixedColor[3]})`;
        };

        // 공연 조합과 데이터 준비
        const combinationData = [
            {% for combo, count in combination_counts.items %}
            { label: "{{ combo }}", count: {{ count }} },
            {% endfor %}
        ];

        // 데이터 정렬 (명수 높은 순)
        combinationData.sort((a, b) => b.count - a.count);

        // 정렬된 데이터를 기반으로 labels, data, backgroundColors, borderColors 생성
        const labels = combinationData.map(item => item.label);
        const data = combinationData.map(item => item.count);
        const backgroundColors = labels.map(combo => generateMixedColor(combo, "background"));
        const borderColors = labels.map(combo => generateMixedColor(combo, "border"));

        new Chart(ctx, {
            type: 'pie',
            data: {
                labels: labels,
                datasets: [{
                    data: data,
                    backgroundColor: backgroundColors,
                    borderColor: borderColors,
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'top',
                    },
                    tooltip: {
                        callbacks: {
                            label: function (context) {
                                return `${context.label}: ${context.raw}명`;
                            }
                        }
                    }
                }
            }
        });
    });
</script>
{% endblock scripts %}
