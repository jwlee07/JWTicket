{% extends "review/base.html" %}
{% load static %}

{% block content %}
<div class="content-container mt-5">
    <!-- 이 페이지는 '리뷰 분석 결과'를 보여줍니다. 
         리뷰 데이터를 토대로 다양한 분석 결과를 시각적으로 확인할 수 있습니다. -->
    <h1 class="text-center mb-5">리뷰 분석 결과</h1>

    <!-- 분석 결과는 analysis_type이라는 값에 따라 다른 내용을 보여줍니다. -->

    <div class="mt-4">
        {% if analysis_type == 'long_reviews' %}
        <!-- 길게 남긴 리뷰: 
             리뷰 길이가 긴 것들만 모아 보여줍니다.
             이렇게 하면 관객들이 어떤 점을 길게 이야기했는지 파악할 수 있습니다. -->
        <h3 class="mt-3">길게 남긴 리뷰</h3>
        <p class="text-muted">리뷰 중에서도 유독 길게 작성된 것들을 모아둔 목록입니다.  
        관객이 공연에 대해 자세히 언급한 부분을 확인할 수 있습니다.</p>
        <div class="row">
            {% for review in data %}
            <div class="col-12 mb-3">
                <div class="card p-3">
                    <p><strong>닉네임:</strong> {{ review.nickname }}</p>
                    <p><strong>평점:</strong> {{ review.star_rating }}</p>
                    <p><strong>내용:</strong> {{ review.description }}</p>
                </div>
            </div>
            {% endfor %}
        </div>

        {% elif analysis_type == 'frequent_reviewers' %}
        <!-- 여러 번 리뷰를 남긴 관객:
             같은 사람이 여러 번 관람하거나 리뷰를 남긴 경우, 그 사람의 리뷰를 모아볼 수 있습니다.
             이를 통해 특정 관객이 공연에 대해 어떤 생각을 지속적으로 남겼는지 파악할 수 있습니다. -->
        <h3 class="mt-3">여러 번 리뷰를 작성한 관객</h3>
        <p class="text-muted">같은 관객이 남긴 여러 리뷰를 모았습니다.  
        이로써 그 관객이 공연에 대해 꾸준히 느낀 점이나 변화되는 의견을 확인할 수 있습니다.</p>
        <div class="row">
            {% for reviewer in data %}
            <div class="col-12 mb-3">
                <div class="card p-3">
                    <p><strong>닉네임:</strong> {{ reviewer.nickname }}</p>
                    <p><strong>리뷰 작성 수:</strong> {{ reviewer.review_count }}회</p>
                    <ul>
                        {% for review in reviewer.reviews %}
                        <li>{{ review.description|truncatewords:20 }}</li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
            {% endfor %}
        </div>

        {% elif analysis_type == 'frequent_words' %}
        <!-- 자주 등장한 단어:
             리뷰에 어떤 단어가 가장 많이 나오는지 알려줍니다.
             이로써 관객들이 공연을 이야기할 때 주로 어떤 점을 강조하는지 알 수 있습니다. -->
        <h3 class="mt-3">자주 등장한 단어</h3>
        <p class="text-muted">리뷰에서 특히 많이 언급되는 단어들을 그래프로 보여줍니다.  
        이를 통해 공연을 표현하는데 가장 자주 사용되는 표현을 쉽게 파악할 수 있습니다.</p>
        <div class="card p-3">
            <canvas id="frequentWordsChart" width="100%" height="50"></canvas>
        </div>

        {% elif analysis_type == 'frequent_words_mix' %}
        <!-- 자주 등장한 단어 조합:
             단어 혼자가 아니라, 같이 자주 나오는 단어들(예: '무대'와 '배우')을 보여줍니다.
             이렇게 하면 관객들이 어떤 주제나 특징을 함께 언급하는지 알 수 있습니다. -->
        <h3 class="mt-3">자주 등장한 단어 조합</h3>
        <p class="text-muted">리뷰 속에서 함께 자주 등장하는 단어 묶음을 보여줍니다.  
        이를 통해 관객들이 주로 어떤 주제나 특징을 연관 지어 이야기하는지 알 수 있습니다.</p>
        <div class="card p-3">
            <canvas id="frequentWordsMixChart" width="100%" height="50"></canvas>
        </div>

        {% elif analysis_type == 'frequent_words_important' %}
        <!-- 상대적으로 중요한 단어 조합:
             단순히 많이 나온 단어가 아니라, 다른 단어들과 비교했을 때 유독 의미 있는 단어 조합을 보여줍니다.
             이는 공연에 대한 독특한 관점이나 키워드를 찾는 데 도움을 줍니다. -->
        <h3 class="mt-3">상대적으로 중요한 단어 조합</h3>
        <p class="text-muted">빈도뿐 아니라 중요도를 고려한 단어 조합을 보여줍니다.  
        이로써 전체 리뷰 중에서 특히 의미 있고 특징적인 단어 묶음을 파악할 수 있습니다.</p>
        <div class="card p-3">
            <canvas id="frequentWordsImportantChart" width="100%" height="50"></canvas>
        </div>

        {% elif analysis_type == 'similar_reviews' %}
        <!-- 비슷한 리뷰:
             내용이 서로 비슷한 리뷰들을 한 데 모아 보여줍니다.
             이를 통해 비슷한 반응을 보인 관객들을 이해하고, 어떤 점에서 의견이 모이는지 파악할 수 있습니다. -->
        <h3 class="mt-3">비슷한 리뷰 모음</h3>
        <p class="text-muted">비슷한 의견이나 느낌의 리뷰를 묶어 보여줍니다.  
        이를 통해 특정 주제나 분위기에 대해 관객들이 공통적으로 어떻게 생각하는지 쉽게 파악할 수 있습니다.</p>
        <div class="row">
            {% for cluster, reviews in data.items %}
            <div class="col-12 mb-3">
                <div class="card p-3">
                    <strong>비슷한 리뷰 그룹 {{ cluster }}</strong>
                    <ul class="mt-2">
                        {% for review in reviews %}
                        <li>
                            <strong>{{ review.nickname }}:</strong> {{ review.content|truncatewords:30 }}
                        </li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
            {% endfor %}
        </div>

        {% elif analysis_type == 'top_view_count_reviews' %}
        <!-- 조회수가 높은 리뷰:
             다른 관객들에게도 많은 관심을 받은 인기 리뷰를 보여줍니다.
             어떤 리뷰가 주목받는지 확인할 수 있습니다. -->
        <h3 class="mt-3">조회수가 높은 리뷰</h3>
        <p class="text-muted">많은 관객이 읽은 리뷰를 보여줍니다.  
        인기가 높은 리뷰를 통해 공연에 대한 대중적인 반응이나 흥미로운 포인트를 파악할 수 있습니다.</p>
        <div class="row">
            {% for review in data %}
            <div class="col-12 mb-3">
                <div class="card p-3">
                    <p><strong>닉네임:</strong> {{ review.nickname }}</p>
                    <p><strong>조회수:</strong> {{ review.view_count }}</p>
                    <p><strong>내용:</strong> {{ review.description }}</p>
                </div>
            </div>
            {% endfor %}
        </div>

        {% elif analysis_type == 'low_star_rating_reviews' %}
        <!-- 평점 3점 이하 리뷰:
             만족도가 낮은 리뷰만 모아서 공연의 문제점이나 개선점을 파악하는 데 도움을 줍니다. -->
        <h3 class="mt-3">평점 3점 이하인 리뷰</h3>
        <p class="text-muted">평점이 낮은 리뷰를 모았습니다.  
        이를 통해 공연에서 관객들이 아쉬워하거나 불만을 느낀 점을 파악할 수 있습니다.</p>
        <div class="row">
            {% for review in data %}
            <div class="col-12 mb-3">
                <div class="card p-3">
                    <p><strong>닉네임:</strong> {{ review.nickname }}</p>
                    <p><strong>평점:</strong> {{ review.star_rating }}</p>
                    <p><strong>내용:</strong> {{ review.description }}</p>
                </div>
            </div>
            {% endfor %}
        </div>

        {% else %}
        <!-- 어떤 분석 결과도 없는 경우 -->
        <p class="text-center text-muted">분석 결과가 없습니다.</p>
        {% endif %}
    </div>
</div>
<div class="mt-5" style="height: 12px;"></div>
{% endblock content %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// 이 스크립트는 막대 그래프를 생성하는 역할을 합니다.
// 분석 결과 중 그래프로 보여줄 수 있는 경우(자주 등장한 단어 등)에 활용됩니다.
document.addEventListener('DOMContentLoaded', function() {
    function drawBarChart(ctxId, labels, values, title) {
        const ctx = document.getElementById(ctxId).getContext('2d');
        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: title,
                    data: values,
                    backgroundColor: 'rgba(54, 162, 235, 0.5)',
                    borderColor: 'rgba(54, 162, 235, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                scales: {
                    x: { title: { display: true, text: '단어 또는 단어 조합' } },
                    y: { beginAtZero: true, title: { display: true, text: '빈도 혹은 중요도' } }
                },
                plugins: { legend: { display: false } }
            }
        });
    }

    // 아래는 그래프가 필요한 경우에만 실행되는 코드입니다.
    // 예: '자주 등장한 단어', '자주 등장한 단어 조합', '중요 단어 조합' 등의 경우
    {% if analysis_type == 'frequent_words' %}
    const fwLabels = [
        {% for word, count in data|slice:":20" %}
        "{{ word }}",
        {% endfor %}
    ];
    const fwValues = [
        {% for word, count in data|slice:":20" %}
        {{ count }},
        {% endfor %}
    ];
    drawBarChart('frequentWordsChart', fwLabels, fwValues, '단어 빈도');

    {% elif analysis_type == 'frequent_words_mix' %}
    const fwmLabels = [
        {% for word, count in data|slice:":20" %}
        "{{ word }}",
        {% endfor %}
    ];
    const fwmValues = [
        {% for word, count in data|slice:":20" %}
        {{ count }},
        {% endfor %}
    ];
    drawBarChart('frequentWordsMixChart', fwmLabels, fwmValues, '단어 조합 빈도');

    {% elif analysis_type == 'frequent_words_important' %}
    const fwiLabels = [
        {% for word, importance in data|slice:":20" %}
        "{{ word }}",
        {% endfor %}
    ];
    const fwiValues = [
        {% for word, importance in data|slice:":20" %}
        {{ importance }},
        {% endfor %}
    ];
    drawBarChart('frequentWordsImportantChart', fwiLabels, fwiValues, '단어 조합 중요도');
    {% endif %}
});
</script>
{% endblock scripts %}
