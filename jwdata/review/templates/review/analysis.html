{% extends "review/base.html" %}
{% load static %}

{% block content %}
<div class="content-container mt-5">
    <div class="d-flex align-items-center justify-content-between">
        <h1 class="text-center flex-grow-1">리뷰 분석 결과</h1>
    </div>

    <div class="mt-4">
        {% if analysis_type == 'long_reviews' %}
        <h3 class="mt-3">길게 남긴 리뷰</h3>
        <div class="row">
            {% for review in data %}
            <div class="col-12 mb-3">
                <div class="card">
                    <div class="card-body">
                        <p><strong>닉네임:</strong> {{ review.nickname }}</p>
                        <p><strong>평점:</strong> {{ review.star_rating }}</p>
                        <p><strong>내용:</strong> {{ review.description }}</p>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>

        {% elif analysis_type == 'frequent_reviewers' %}
        <h3 class="mt-3">여러 번 리뷰를 작성한 관객</h3>
        <div class="row">
            {% for reviewer in data %}
            <div class="col-12 mb-3">
                <div class="card">
                    <div class="card-body">
                        <p><strong>닉네임:</strong> {{ reviewer.nickname }}</p>
                        <p><strong>리뷰 작성 수:</strong> {{ reviewer.review_count }}회</p>
                        <ul>
                            {% for review in reviewer.reviews %}
                            <li>{{ review.description|truncatewords:20 }}</li>
                            {% endfor %}
                        </ul>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>

        {% elif analysis_type == 'frequent_words' %}
        <h3 class="mt-3">
            자주 등장한 단어
            <span class="ms-2" data-bs-toggle="tooltip" data-bs-placement="top" title="여러 관객이 공통적으로 많이 언급한 단어들을 그래프로 보여줍니다. 어떤 단어들이 가장 많이 언급되었는지 알 수 있어요.(Konlpy OKt 적용)">
                <i class="bi bi-question-circle" style="cursor: pointer;"></i>
            </span>
        </h3>
        <!-- 막대 그래프를 그릴 canvas 추가 -->
        <div class="card p-3">
            <canvas id="frequentWordsChart" width="100%" height="50"></canvas>
        </div>

        {% elif analysis_type == 'frequent_words_mix' %}
        <h3 class="mt-3">
            자주 등장한 단어 조합
            <span class="ms-2" data-bs-toggle="tooltip" data-bs-placement="top" title="단어들이 함께 자주 언급되는 조합을 보여줍니다. 어떤 단어들이 짝을 이루어 자주 등장하는지 알 수 있어, 관객들이 어떤 주제를 함께 묶어 이야기하는지 파악할 수 있어요.(scikit-learn, CountVectorizer 적용)">
                <i class="bi bi-question-circle" style="cursor: pointer;"></i>
            </span>
        </h3>
        <!-- 막대 그래프를 그릴 canvas 추가 -->
        <div class="card p-3">
            <canvas id="frequentWordsMixChart" width="100%" height="50"></canvas>
        </div>

        {% elif analysis_type == 'frequent_words_important' %}
        <h3 class="mt-3">
            상대적 중요도가 높은 단어 조합
            <span class="ms-2" data-bs-toggle="tooltip" data-bs-placement="top" title="단순히 많이 나오는 단어뿐 아니라, 다른 단어들과 비교했을 때 상대적으로 중요하고 의미 있는 단어 조합을 보여줍니다. 즉, 전체 리뷰 중에서 특별히 의미가 두드러지는 단어 묶음을 알 수 있어요.(scikit-learn, TfidfVectorizer 적용)">
                <i class="bi bi-question-circle" style="cursor: pointer;"></i>
            </span>
        </h3>
        <!-- 막대 그래프를 그릴 canvas 추가 -->
        <div class="card p-3">
            <canvas id="frequentWordsImportantChart" width="100%" height="50"></canvas>
        </div>

        {% elif analysis_type == 'similar_reviews' %}
        <h3 class="mt-3">
            비슷한 리뷰
            <span class="ms-2" data-bs-toggle="tooltip" data-bs-placement="top" title="비슷한 내용의 리뷰들을 모아 보여줍니다. 이를 통해 비슷한 의견, 느낌, 분위기를 가진 관객들의 생각을 한눈에 파악할 수 있어요.(scikit-learn, KMeans Clustering 적용)">
                <i class="bi bi-question-circle" style="cursor: pointer;"></i>
            </span>
        </h3>
        <div class="row">
            {% for cluster, reviews in data.items %}
            <div class="col-12 mb-3">
                <div class="card">
                    <div class="card-header">
                        <strong>클러스터 {{ cluster }}</strong>
                    </div>
                    <div class="card-body">
                        <ul>
                            {% for review in reviews %}
                            <li>
                                <strong>{{ review.nickname }}:</strong> {{ review.content|truncatewords:30 }}
                            </li>
                            {% endfor %}
                        </ul>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>

        {% elif analysis_type == 'top_view_count_reviews' %}
        <h3 class="mt-3">조회수가 높은 리뷰</h3>
        <div class="row">
            {% for review in data %}
            <div class="col-12 mb-3">
                <div class="card">
                    <div class="card-body">
                        <p><strong>닉네임:</strong> {{ review.nickname }}</p>
                        <p><strong>조회수:</strong> {{ review.view_count }}</p>
                        <p><strong>내용:</strong> {{ review.description }}</p>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>

        {% elif analysis_type == 'low_star_rating_reviews' %}
        <h3 class="mt-3">평점이 3점 이하인 리뷰</h3>
        <div class="row">
            {% for review in data %}
            <div class="col-12 mb-3">
                <div class="card">
                    <div class="card-body">
                        <p><strong>닉네임:</strong> {{ review.nickname }}</p>
                        <p><strong>평점:</strong> {{ review.star_rating }}</p>
                        <p><strong>내용:</strong> {{ review.description }}</p>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>

        {% else %}
        <p class="text-muted text-center">분석 데이터를 찾을 수 없습니다.</p>
        {% endif %}
    </div>
</div>
<div class="mt-5" style="height: 12px;"></div>
{% endblock content %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// DOM 로드 후 실행
document.addEventListener('DOMContentLoaded', function() {
    // Bootstrap Tooltip 초기화 (Bootstrap 5)
    const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
    tooltipTriggerList.forEach(function (tooltipTriggerEl) {
      new bootstrap.Tooltip(tooltipTriggerEl)
    });

    // 막대 그래프를 그리는 함수
    function drawBarChart(ctxId, labels, values, title) {
        const ctx = document.getElementById(ctxId).getContext('2d');
        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: title,
                    data: values,
                    backgroundColor: 'rgba(54, 162, 235, 0.5)',
                    borderColor: 'rgba(54, 162, 235, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                scales: {
                    x: { title: { display: true, text: '단어/단어 조합', font: {size:14, weight:'bold'} } },
                    y: { beginAtZero: true, title: { display: true, text: '빈도/중요도', font: {size:14, weight:'bold'} } }
                },
                plugins: {
                    legend: { display: false },
                }
            }
        });
    }

    {% if analysis_type == 'frequent_words' %}
    const fwLabels = [
        {% for word, count in data|slice:":20" %}
        "{{ word }}",
        {% endfor %}
    ];
    const fwValues = [
        {% for word, count in data|slice:":20" %}
        {{ count }},
        {% endfor %}
    ];
    drawBarChart('frequentWordsChart', fwLabels, fwValues, '단어 빈도');

    {% elif analysis_type == 'frequent_words_mix' %}
    const fwmLabels = [
        {% for word, count in data|slice:":20" %}
        "{{ word }}",
        {% endfor %}
    ];
    const fwmValues = [
        {% for word, count in data|slice:":20" %}
        {{ count }},
        {% endfor %}
    ];
    drawBarChart('frequentWordsMixChart', fwmLabels, fwmValues, '단어 조합 빈도');

    {% elif analysis_type == 'frequent_words_important' %}
    const fwiLabels = [
        {% for word, importance in data|slice:":20" %}
        "{{ word }}",
        {% endfor %}
    ];
    const fwiValues = [
        {% for word, importance in data|slice:":20" %}
        {{ importance }},
        {% endfor %}
    ];
    drawBarChart('frequentWordsImportantChart', fwiLabels, fwiValues, '단어 조합 중요도');

    {% endif %}
});
</script>
{% endblock scripts %}
