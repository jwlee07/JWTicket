{% extends "review/base.html" %}

{% block content %}
<div class="content-container mt-5">
    <h1 class="text-center">공연 리뷰 정보</h1>

    <!-- 검색 폼 -->
    <form method="POST" class="mt-4">
        {% csrf_token %}
        <div class="mb-3">
            <label for="query" class="form-label">검색어</label>
            <input type="text" class="form-control" id="query" name="query" placeholder="공연명을 입력하세요">
        </div>
        <button type="submit" class="btn btn-primary w-100">검색</button>
    </form>

    <!-- 공연 정보 버튼 -->
    {% if concerts %}
    <h3 class="mt-5">공연 목록</h3>
    <div id="concert-buttons" class="btn-group mt-3 w-100" role="group" aria-label="공연 선택">
        {% for concert in concerts %}
        <button class="btn btn-outline-primary {% if concert.id|stringformat:"s" == active_concert_id %}active{% endif %}" 
                data-concert-id="{{ concert.id }}" 
                onclick="showConcert('{{ concert.id }}')">
            {{ concert.name }}
        </button>
        {% endfor %}
    </div>

    <!-- 공연 및 리뷰 정보 -->
    {% for concert in concerts %}
    <div id="concert-{{ concert.id }}" class="mt-4 concert-section" style="{% if concert.id|stringformat:"s" != active_concert_id %}display: none;{% endif %}">
        <h3>{{ concert.name }}</h3>
        <p><strong>장소:</strong> {{ concert.place }}</p>
        <p><strong>기간:</strong> {{ concert.start_date }} ~ {{ concert.end_date }}</p>
        <p><strong>공연 시간:</strong> {{ concert.duration_minutes|default:"-" }}분</p>
        <p><strong>리뷰 수:</strong> {{ concert.reviews.count }}</p>

        <!-- 리뷰 분석 버튼 -->
        <h3 class="mt-5">리뷰 분석 리스트</h3>
        <div class="analysis-buttons mt-3">
            <a href="{% url 'analyze_reviews' concert.id 'long_reviews' %}" class="btn btn-secondary w-30 mb-2">
                리뷰를 길게 남긴 관객 뭐라고 작성했을까?
            </a>
            <a href="{% url 'analyze_reviews' concert.id 'frequent_reviewers' %}" class="btn btn-secondary w-30 mb-2">
                여러번 리뷰를 작성한 관객 어떤 리뷰를 달았을까?
            </a>
            <a href="{% url 'analyze_reviews' concert.id 'frequent_words' %}" class="btn btn-secondary w-30 mb-2">
                리뷰 텍스트에는 어떤 단어가 가장 많이 나왔을까?
            </a>
            <a href="{% url 'analyze_reviews' concert.id 'similar_reviews' %}" class="btn btn-secondary w-30 mb-2">
                비슷한 리뷰 내용은 어떤 게 있을까?
            </a>
            <a href="{% url 'analyze_reviews' concert.id 'top_view_count_reviews' %}" class="btn btn-secondary w-30 mb-2">
                조회수가 높은 리뷰들은 어떤 내용일까?
            </a>
            <a href="{% url 'analyze_reviews' concert.id 'low_star_rating_reviews' %}" class="btn btn-secondary w-30 mb-2">
                평점이 3점 이하인 리뷰를 작성한 관객은 어떤 리뷰를 달았을까?
            </a>
        </div>

        <!-- 리뷰 테이블 -->
        <h3 class="mt-5">리뷰 테이블</h3>
        {% if concert.reviews.exists %}
        <table class="table table-sm">
            <thead>
                <tr class="text-center">
                    <th style="width: 80px;">작성자</th>
                    <th style="width: 150px;">작성일</th>
                    <th style="width: 80px;">별점</th>
                    <th>제목</th>
                    <th>내용</th>
                </tr>
            </thead>
            <tbody>
                {% for review in concert.reviews.all %}
                <tr>
                    <td>{{ review.nickname }}</td>
                    <td>{{ review.date }}</td>
                    <td>{{ review.star_rating }}/5</td>
                    <td>{{ review.title }}</td>
                    <td>{{ review.description }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <p class="text-muted text-center">리뷰가 없습니다.</p>
        {% endif %}
    </div>
    {% endfor %}
    {% else %}
    <p class="text-center text-muted mt-5">현재 등록된 공연 정보가 없습니다.</p>
    {% endif %}
</div>
{% endblock content %}

{% block scripts %}
<script>
    function showConcert(concertId) {
        // 모든 공연 섹션 숨기기
        document.querySelectorAll('.concert-section').forEach(section => {
            section.style.display = 'none';
        });
        // 선택된 공연 섹션 보이기
        document.getElementById(`concert-${concertId}`).style.display = 'block';

        // 모든 버튼의 활성화 클래스 제거
        document.querySelectorAll('#concert-buttons button').forEach(button => {
            button.classList.remove('active');
        });

        // 선택된 버튼 활성화
        document.querySelector(`[data-concert-id="${concertId}"]`).classList.add('active');

        // URL 업데이트
        const url = new URL(window.location.href);
        url.searchParams.set('active_concert_id', concertId);
        history.pushState({}, '', url);
    }
</script>
{% endblock scripts %}
