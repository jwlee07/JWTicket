{% extends "review/base.html" %}
{% load static %}

{% block content %}
<div class="d-flex" style="min-height: 100vh;">
    <!-- 사이드바 -->
    <nav id="sidebar" class="bg-dark text-white p-3" style="min-width:250px; transition: all 0.3s; overflow-x:hidden;">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h4 class="mb-0">공연 데이터 대시보드</h4>
            <button class="btn btn-sm btn-outline-light" id="toggleSidebarBtn" title="사이드바 접기/펼치기">◀</button>
        </div>

        {% if concerts %}
        <h5 class="mt-4">통합</h5>
        <div class="btn-group-vertical w-100 mt-2" role="group" aria-label="통합 바로가기">
            <a href="{% url 'analyze_all_reviews' %}" class="btn btn-outline-light text-start">공연 리뷰</a>
            <a href="{% url 'analyze_all_pattern' %}" class="btn btn-outline-light text-start">관람 패턴</a>
            <a href="{% url 'analyze_all_seats' %}" class="btn btn-outline-light text-start">잔여 좌석</a>
        </div>

        <h5 class="mt-4">연극</h5>
        <div class="btn-group-vertical w-100 mt-2" role="group" aria-label="공연 선택">
            {% for concert in concerts|dictsort:"name" %}
                {% if concert.genre == '연극' %}
                    <button
                        class="btn btn-outline-light text-start {% if concert.id|stringformat:"s" == active_concert_id %}active{% endif %}" 
                        data-concert-id="{{ concert.id }}" 
                        onclick="showConcert('{{ concert.id }}')">
                        {{ concert.name }}
                    </button>
                {% endif %}
            {% endfor %}
        </div>

        <h5 class="mt-4">뮤지컬</h5>
        <div class="btn-group-vertical w-100 mt-2" role="group" aria-label="공연 선택">
            {% for concert in concerts|dictsort:"name" %}
                {% if concert.genre == '뮤지컬' %}
                    <button
                        class="btn btn-outline-light text-start {% if concert.id|stringformat:"s" == active_concert_id %}active{% endif %}" 
                        data-concert-id="{{ concert.id }}" 
                        onclick="showConcert('{{ concert.id }}')">
                        {{ concert.name }}
                    </button>
                {% endif %}
            {% endfor %}
        </div>

        <h5 class="mt-4">콘서트</h5>
        <div class="btn-group-vertical w-100 mt-2" role="group" aria-label="공연 선택">
            {% for concert in concerts|dictsort:"name" %}
                {% if concert.genre == '콘서트' %}
                    <button
                        class="btn btn-outline-light text-start {% if concert.id|stringformat:"s" == active_concert_id %}active{% endif %}" 
                        data-concert-id="{{ concert.id }}" 
                        onclick="showConcert('{{ concert.id }}')">
                        {{ concert.name }}
                    </button>
                {% endif %}
            {% endfor %}
        </div>
        {% else %}
        <p class="mt-5 text-muted">현재 등록된 공연 정보가 없습니다.</p>
        {% endif %}
    </nav>

    <div class="flex-grow-1 p-3">
        <div class="mt-4">
            <h3>평균 평점과 총 리뷰 수</h3>
            <table class="table table-bordered table-hover mt-3">
                <thead class="table-dark">
                    <tr>
                        <th>장르</th>
                        <th>평균 평점</th>
                        <th>총 리뷰 수</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>전체</td>
                        <td>{{ avg_all|floatformat:1|default:"0.0" }}/10</td>
                        <td>{{ count_all|default:"0" }}</td>
                    </tr>
                    <tr>
                        <td>연극</td>
                        <td>{{ avg_play|floatformat:1|default:"0.0" }}/10</td>
                        <td>{{ count_play|default:"0" }}</td>
                    </tr>
                    <tr>
                        <td>뮤지컬</td>
                        <td>{{ avg_musical|floatformat:1|default:"0.0" }}/10</td>
                        <td>{{ count_musical|default:"0" }}</td>
                    </tr>
                    <tr>
                        <td>콘서트</td>
                        <td>{{ avg_concert|floatformat:1|default:"0.0" }}/10</td>
                        <td>{{ count_concert|default:"0" }}</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <h3>리뷰 요약</h3>
        <div class="row">
            <div class="col-md-6 mb-6">
                {% if img_all %}
                    <h5>전체</h5>
                    <img src="data:image/png;base64,{{ img_all }}" 
                        alt="공연 전체 워드클라우드" 
                        class="img-fluid" 
                        style="max-height: 600px;">
                {% else %}
                    <p>공연 전체 리뷰 데이터가 부족하거나 없습니다.</p>
                {% endif %}
            </div>
        </div>

        <!-- 워드클라우드 (연극) -->
        <div class="row">
            <div class="col-md-6 mb-6">
                {% if img_play %}
                    <h5>연극</h5>
                    <img src="data:image/png;base64,{{ img_play }}" 
                        alt="연극 리뷰 워드클라우드" 
                        class="img-fluid" 
                        style="max-height: 600px;">
                {% else %}
                    <p>연극 리뷰 데이터가 부족하거나 없습니다.</p>
                {% endif %}
            </div>
        </div>

        <div class="row">
            <div class="col-md-6 mb-6">
                {% if img_musical %}
                    <h5>뮤지컬</h5>
                    <img src="data:image/png;base64,{{ img_musical }}" 
                        alt="뮤지컬 리뷰 워드클라우드" 
                        class="img-fluid" 
                        style="max-height: 600px;">
                {% else %}
                    <p>뮤지컬 리뷰 데이터가 부족하거나 없습니다.</p>
                {% endif %}
            </div>
        </div>

        <div class="row">
            <div class="col-md-6 mb-6">
                {% if img_concert %}
                    <h5>콘서트</h5>
                    <img src="data:image/png;base64,{{ img_concert }}" 
                        alt="콘서트 리뷰 워드클라우드" 
                        class="img-fluid" 
                        style="max-height: 600px;">
                {% else %}
                    <p>콘서트 리뷰 데이터가 부족하거나 없습니다.</p>
                {% endif %}
            </div>
        </div>
    </div>  
</div>      
{% endblock content %}

{% block scripts %}
{% endblock scripts %}
