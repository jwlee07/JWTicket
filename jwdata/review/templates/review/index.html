{% extends "review/base.html" %}
{% load static %}

{% block content %}
<div class="d-flex" style="min-height: 100vh;">
    <!-- 사이드바 -->
    <nav id="sidebar" class="bg-dark text-white p-3" style="min-width: 250px; transition: all 0.3s; overflow-x: hidden;">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h4 class="mb-0">공연 대시보드</h4>
        </div>
        {% if concerts %}
            <div class="mb-4">
                <h5>통합</h5>
                <div class="btn-group-vertical w-100 mt-2" role="group" aria-label="통합 바로가기">
                    <a href="{% url 'analyze_all_reviews' %}" class="btn btn-outline-light text-start">공연 리뷰</a>
                    <a href="{% url 'analyze_all_pattern' %}" class="btn btn-outline-light text-start">관람 패턴</a>
                    <a href="{% url 'analyze_all_seats' %}" class="btn btn-outline-light text-start">잔여 좌석</a>
                </div>
            </div>
            <!-- 장르별 공연 목록 -->
            <div class="mb-4">
                <h5>연극</h5>
                <div class="btn-group-vertical w-100 mt-2" role="group" aria-label="연극 공연 선택">
                    {% for concert in concerts|dictsort:"name" %}
                        {% if concert.genre == '연극' %}
                            <button class="btn btn-outline-light text-start {% if concert.id|stringformat:"s" == active_concert_id %}active{% endif %}" 
                                    data-concert-id="{{ concert.id }}" 
                                    onclick="showConcert('{{ concert.id }}')">
                                {{ concert.name }}
                            </button>
                        {% endif %}
                    {% endfor %}
                </div>
            </div>
            <div class="mb-4">
                <h5>뮤지컬</h5>
                <div class="btn-group-vertical w-100 mt-2" role="group" aria-label="뮤지컬 공연 선택">
                    {% for concert in concerts|dictsort:"name" %}
                        {% if concert.genre == '뮤지컬' %}
                            <button class="btn btn-outline-light text-start {% if concert.id|stringformat:"s" == active_concert_id %}active{% endif %}" 
                                    data-concert-id="{{ concert.id }}" 
                                    onclick="showConcert('{{ concert.id }}')">
                                {{ concert.name }}
                            </button>
                        {% endif %}
                    {% endfor %}
                </div>
            </div>
            <div class="mb-4">
                <h5>콘서트</h5>
                <div class="btn-group-vertical w-100 mt-2" role="group" aria-label="콘서트 공연 선택">
                    {% for concert in concerts|dictsort:"name" %}
                        {% if concert.genre == '콘서트' %}
                            <button class="btn btn-outline-light text-start {% if concert.id|stringformat:"s" == active_concert_id %}active{% endif %}" 
                                    data-concert-id="{{ concert.id }}" 
                                    onclick="showConcert('{{ concert.id }}')">
                                {{ concert.name }}
                            </button>
                        {% endif %}
                    {% endfor %}
                </div>
            </div>
        {% else %}
            <p class="mt-5 text-muted">현재 등록된 공연 정보가 없습니다.</p>
        {% endif %}
    </nav>

    <!-- 메인 컨텐츠 영역 -->
    <div class="flex-grow-1 p-3">
        <!-- 상단 액션 버튼 -->
        <div class="d-flex justify-content-end mb-3">
            <a href="{% url 'update_sentiment' %}" class="btn btn-dark me-2">ChatGPT 리뷰 감정 분석</a>
            <a href="{% url 'sync_db_to_sheet' %}" class="btn btn-success me-2">DB → Google Sheet</a>
            <a href="{% url 'sync_sheet_to_db' %}" class="btn btn-success me-2">Google Sheet → DB</a>
        </div>

        <!-- 평점 요약 카드 -->
        <h3 class="mb-3">리뷰 평균 평점</h3>
        <div class="row g-3 mb-4">
            <div class="col-12 col-md-6 col-lg-3">
                <div class="card shadow text-center">
                    <div class="card-body">
                        <h5 class="card-title">전체 평균 평점</h5>
                        <h3 class="card-text text-primary">{{ avg_all|floatformat:1|default:"0.0" }}/10</h3>
                        <p class="text-muted small mb-0">총 리뷰: {{ count_all|default:"0" }}건</p>
                    </div>
                </div>
            </div>
            <div class="col-12 col-md-6 col-lg-3">
                <div class="card shadow text-center">
                    <div class="card-body">
                        <h5 class="card-title">연극 평균 평점</h5>
                        <h3 class="card-text text-info">{{ avg_play|floatformat:1|default:"0.0" }}/10</h3>
                        <p class="text-muted small mb-0">연극 리뷰: {{ count_play|default:"0" }}건</p>
                    </div>
                </div>
            </div>
            <div class="col-12 col-md-6 col-lg-3">
                <div class="card shadow text-center">
                    <div class="card-body">
                        <h5 class="card-title">뮤지컬 평균 평점</h5>
                        <h3 class="card-text text-success">{{ avg_musical|floatformat:1|default:"0.0" }}/10</h3>
                        <p class="text-muted small mb-0">뮤지컬 리뷰: {{ count_musical|default:"0" }}건</p>
                    </div>
                </div>
            </div>
            <div class="col-12 col-md-6 col-lg-3">
                <div class="card shadow text-center">
                    <div class="card-body">
                        <h5 class="card-title">콘서트 평균 평점</h5>
                        <h3 class="card-text text-warning">{{ avg_concert|floatformat:1|default:"0.0" }}/10</h3>
                        <p class="text-muted small mb-0">콘서트 리뷰: {{ count_concert|default:"0" }}건</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- 공연별 요약 테이블 -->
        <div class="mt-5">
            <h3>공연별 요약 정보</h3>
            <table class="table table-bordered table-hover mt-3">
                <thead class="table-dark">
                    <tr>
                        <th>장르</th>
                        <th>공연명</th>
                        <th>평균 평점</th>
                        <th>총 리뷰 수</th>
                    </tr>
                </thead>
                <tbody>
                    {% for concert in concert_summary %}
                    <tr>
                        <td>{{ concert.concert__genre }}</td>
                        <td>{{ concert.concert__name }}</td>
                        <td>{{ concert.average_rating|floatformat:1 }}/10</td>
                        <td>{{ concert.total_reviews }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- 공연별 리뷰 수 추이 차트 -->
        <div class="mt-5">
            <h3>최근 30일 공연별 리뷰 수 추이</h3>
            <div class="card p-3">
                <canvas id="reviewChart" width="100%" height="50"></canvas>
            </div>
        </div>

        <!-- 공연별 평균 평점 추이 차트 -->
        <div class="mt-5">
            <h3>최근 30일 공연별 평균 평점 추이 (10점 만점)</h3>
            <div class="card p-3">
                <canvas id="ratingChart" width="100%" height="50"></canvas>
            </div>
        </div>

        <!-- 리뷰 워드클라우드 및 감정 분석 섹션 -->
        <div class="row mt-5">
            <h3 class="mb-3">리뷰 장르별 분석</h3>
            <!-- [전체] 섹션 -->
            <div class="col-12 mb-3">
                <div class="card shadow">
                    <div class="card-header">
                        <h5 class="card-title">[전체]</h5>
                    </div>
                    <div class="card-body">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header">
                                        <h6>모든 리뷰의 워드클라우드</h6>
                                    </div>
                                    <div class="card-body d-flex align-items-center justify-content-center">
                                        {% if img_all %}
                                            <img src="data:image/png;base64,{{ img_all }}" alt="전체 워드클라우드" class="img-fluid" style="max-height: 300px;">
                                        {% else %}
                                            <p class="text-muted">전체 리뷰 데이터가 부족합니다.</p>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header">
                                        <h6>감정분석 그래프</h6>
                                    </div>
                                    <div class="card-body">
                                        <canvas id="emotionChartAll" height="150"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header">
                                        <h6>긍정 리뷰의 워드클라우드</h6>
                                    </div>
                                    <div class="card-body d-flex align-items-center justify-content-center">
                                        {% if img_all_positive %}
                                            <img src="data:image/png;base64,{{ img_all_positive }}" alt="전체 긍정 워드클라우드" class="img-fluid" style="max-height: 300px;">
                                        {% else %}
                                            <p class="text-muted">긍정 리뷰 데이터가 부족합니다.</p>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header">
                                        <h6>부정 리뷰의 워드클라우드</h6>
                                    </div>
                                    <div class="card-body d-flex align-items-center justify-content-center">
                                        {% if img_all_negative %}
                                            <img src="data:image/png;base64,{{ img_all_negative }}" alt="전체 부정 워드클라우드" class="img-fluid" style="max-height: 300px;">
                                        {% else %}
                                            <p class="text-muted">부정 리뷰 데이터가 부족합니다.</p>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- [연극] 섹션 -->
            <div class="col-12 mb-3">
                <div class="card shadow">
                    <div class="card-header">
                        <h5 class="card-title">[연극]</h5>
                    </div>
                    <div class="card-body">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header">
                                        <h6>모든 리뷰의 워드클라우드</h6>
                                    </div>
                                    <div class="card-body d-flex align-items-center justify-content-center">
                                        {% if img_play %}
                                            <img src="data:image/png;base64,{{ img_play }}" alt="연극 전체 워드클라우드" class="img-fluid" style="max-height: 300px;">
                                        {% else %}
                                            <p class="text-muted">전체 리뷰 데이터가 부족합니다.</p>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header">
                                        <h6>감정분석 그래프</h6>
                                    </div>
                                    <div class="card-body">
                                        <canvas id="emotionChartPlay" height="150"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header">
                                        <h6>긍정 리뷰의 워드클라우드</h6>
                                    </div>
                                    <div class="card-body d-flex align-items-center justify-content-center">
                                        {% if img_play_positive %}
                                            <img src="data:image/png;base64,{{ img_play_positive }}" alt="연극 긍정 워드클라우드" class="img-fluid" style="max-height: 300px;">
                                        {% else %}
                                            <p class="text-muted">긍정 리뷰 데이터가 부족합니다.</p>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header">
                                        <h6>부정 리뷰의 워드클라우드</h6>
                                    </div>
                                    <div class="card-body d-flex align-items-center justify-content-center">
                                        {% if img_play_negative %}
                                            <img src="data:image/png;base64,{{ img_play_negative }}" alt="연극 부정 워드클라우드" class="img-fluid" style="max-height: 300px;">
                                        {% else %}
                                            <p class="text-muted">부정 리뷰 데이터가 부족합니다.</p>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- [뮤지컬] 섹션 -->
            <div class="col-12 mb-3">
                <div class="card shadow">
                    <div class="card-header">
                        <h5 class="card-title">[뮤지컬]</h5>
                    </div>
                    <div class="card-body">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header">
                                        <h6>모든 리뷰의 워드클라우드</h6>
                                    </div>
                                    <div class="card-body d-flex align-items-center justify-content-center">
                                        {% if img_musical %}
                                            <img src="data:image/png;base64,{{ img_musical }}" alt="뮤지컬 전체 워드클라우드" class="img-fluid" style="max-height: 300px;">
                                        {% else %}
                                            <p class="text-muted">전체 리뷰 데이터가 부족합니다.</p>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header">
                                        <h6>감정분석 그래프</h6>
                                    </div>
                                    <div class="card-body">
                                        <canvas id="emotionChartMusical" height="150"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header">
                                        <h6>긍정 리뷰의 워드클라우드</h6>
                                    </div>
                                    <div class="card-body d-flex align-items-center justify-content-center">
                                        {% if img_musical_positive %}
                                            <img src="data:image/png;base64,{{ img_musical_positive }}" alt="뮤지컬 긍정 워드클라우드" class="img-fluid" style="max-height: 300px;">
                                        {% else %}
                                            <p class="text-muted">긍정 리뷰 데이터가 부족합니다.</p>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header">
                                        <h6>부정 리뷰의 워드클라우드</h6>
                                    </div>
                                    <div class="card-body d-flex align-items-center justify-content-center">
                                        {% if img_musical_negative %}
                                            <img src="data:image/png;base64,{{ img_musical_negative }}" alt="뮤지컬 부정 워드클라우드" class="img-fluid" style="max-height: 300px;">
                                        {% else %}
                                            <p class="text-muted">부정 리뷰 데이터가 부족합니다.</p>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- [콘서트] 섹션 -->
            <div class="col-12 mb-3">
                <div class="card shadow">
                    <div class="card-header">
                        <h5 class="card-title">[콘서트]</h5>
                    </div>
                    <div class="card-body">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header">
                                        <h6>모든 리뷰의 워드클라우드</h6>
                                    </div>
                                    <div class="card-body d-flex align-items-center justify-content-center">
                                        {% if img_concert %}
                                            <img src="data:image/png;base64,{{ img_concert }}" alt="콘서트 전체 워드클라우드" class="img-fluid" style="max-height: 300px;">
                                        {% else %}
                                            <p class="text-muted">전체 리뷰 데이터가 부족합니다.</p>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header">
                                        <h6>감정분석 그래프</h6>
                                    </div>
                                    <div class="card-body">
                                        <canvas id="emotionChartConcert" height="150"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header">
                                        <h6>긍정 리뷰의 워드클라우드</h6>
                                    </div>
                                    <div class="card-body d-flex align-items-center justify-content-center">
                                        {% if img_concert_positive %}
                                            <img src="data:image/png;base64,{{ img_concert_positive }}" alt="콘서트 긍정 워드클라우드" class="img-fluid" style="max-height: 300px;">
                                        {% else %}
                                            <p class="text-muted">긍정 리뷰 데이터가 부족합니다.</p>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header">
                                        <h6>부정 리뷰의 워드클라우드</h6>
                                    </div>
                                    <div class="card-body d-flex align-items-center justify-content-center">
                                        {% if img_concert_negative %}
                                            <img src="data:image/png;base64,{{ img_concert_negative }}" alt="콘서트 부정 워드클라우드" class="img-fluid" style="max-height: 300px;">
                                        {% else %}
                                            <p class="text-muted">부정 리뷰 데이터가 부족합니다.</p>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock content %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/moment"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-moment"></script>
<script>
    // 감정 데이터 차트
    document.addEventListener('DOMContentLoaded', function () {
        const emotionAll = {{ emotion_all|safe }};
        const emotionPlay = {{ emotion_play|safe }};
        const emotionMusical = {{ emotion_musical|safe }};
        const emotionConcert = {{ emotion_concert|safe }};
        const emotionLabels = ["긍정", "부정", "중립"];

        function createHorizontalBarChart(ctxId, emotionData, title) {
            const ctx = document.getElementById(ctxId).getContext("2d");
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: emotionLabels,
                    datasets: [{
                        label: title,
                        data: [
                            emotionData.positive || 0,
                            emotionData.negative || 0,
                            emotionData.neutral || 0
                        ],
                        backgroundColor: [
                            'rgba(54, 162, 235, 0.6)',
                            'rgba(255, 99, 132, 0.6)',
                            'rgba(201, 203, 207, 0.6)'
                        ],
                        borderColor: [
                            'rgba(54, 162, 235, 1)',
                            'rgba(255, 99, 132, 1)',
                            'rgba(201, 203, 207, 1)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    scales: {
                        x: {
                            beginAtZero: true,
                            title: { display: true, text: '리뷰 수' }
                        },
                        y: { title: { display: false } }
                    },
                    plugins: { legend: { display: false } }
                }
            });
        }

        createHorizontalBarChart("emotionChartAll", emotionAll, "전체 감정");
        createHorizontalBarChart("emotionChartPlay", emotionPlay, "연극 감정");
        createHorizontalBarChart("emotionChartMusical", emotionMusical, "뮤지컬 감정");
        createHorizontalBarChart("emotionChartConcert", emotionConcert, "콘서트 감정");
    });
</script>
<script>
    // 공연별 날짜 데이터 차트 (리뷰 수 & 평균 평점) - 동일한 공연 색상 사용
    document.addEventListener('DOMContentLoaded', function () {
        const concertDateSummary = {{ concert_date_summary|safe }};
        const concertDateRatingSummary = {{ concert_date_rating_summary|safe }};
        
        // 공연별 색상 맵핑(동일 공연은 동일 색상)
        const concertColors = {};
        function getRandomColor() {
            const r = Math.floor(Math.random() * 256);
            const g = Math.floor(Math.random() * 256);
            const b = Math.floor(Math.random() * 256);
            return `rgba(${r}, ${g}, ${b}, 1)`;
        }
        // 두 JSON 객체를 순회하면서 모든 공연 이름에 대해 색상 지정
        Object.keys(concertDateSummary).forEach(concert => {
            if (!concertColors[concert]) {
                concertColors[concert] = getRandomColor();
            }
        });
        Object.keys(concertDateRatingSummary).forEach(concert => {
            if (!concertColors[concert]) {
                concertColors[concert] = getRandomColor();
            }
        });
        
        // 리뷰 수 추이 데이터셋 구성 (날짜: date_str 사용)
        const reviewDatasets = [];
        for (const concert in concertDateSummary) {
            const dataPoints = concertDateSummary[concert].map(item => ({
                x: item.date_str,
                y: item.reviews_count
            }));
            reviewDatasets.push({
                label: concert,
                data: dataPoints,
                fill: false,
                borderColor: concertColors[concert],
                tension: 0.1
            });
        }
        
        // 평균 평점 추이 데이터셋 구성 (날짜: date_str 사용)
        const ratingDatasets = [];
        for (const concert in concertDateRatingSummary) {
            const dataPoints = concertDateRatingSummary[concert].map(item => ({
                x: item.date_str,
                y: item.average_rating
            }));
            ratingDatasets.push({
                label: concert,
                data: dataPoints,
                fill: false,
                borderColor: concertColors[concert],
                tension: 0.1
            });
        }
        
        // "공연별 리뷰 수 추이" 차트 생성
        const reviewCtx = document.getElementById("reviewChart").getContext("2d");
        new Chart(reviewCtx, {
            type: 'line',
            data: {
                datasets: reviewDatasets
            },
            options: {
                responsive: true,
                scales: {
                    x: {
                        type: 'time',
                        time: {
                            unit: 'day',
                            tooltipFormat: 'MM월DD일(ddd)',
                            displayFormats: { day: 'MM월DD일(ddd)' }
                        },
                        title: {
                            display: true,
                            text: '날짜',
                            font: { size: 14, weight: 'bold' }
                        }
                    },
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: '리뷰 수',
                            font: { size: 14, weight: 'bold' }
                        }
                    }
                },
                plugins: { legend: { display: true, position: 'bottom' } }
            }
        });
        
        // "공연별 평균 평점 추이 (10점 만점)" 차트 생성
        const ratingCtx = document.getElementById("ratingChart").getContext("2d");
        new Chart(ratingCtx, {
            type: 'line',
            data: {
                datasets: ratingDatasets
            },
            options: {
                responsive: true,
                scales: {
                    x: {
                        type: 'time',
                        time: {
                            unit: 'day',
                            tooltipFormat: 'MM월DD일(ddd)',
                            displayFormats: { day: 'MM월DD일(ddd)' }
                        },
                        title: {
                            display: true,
                            text: '날짜',
                            font: { size: 14, weight: 'bold' }
                        }
                    },
                    y: {
                        beginAtZero: true,
                        suggestedMax: 10,
                        title: {
                            display: true,
                            text: '평균 평점',
                            font: { size: 14, weight: 'bold' }
                        }
                    }
                },
                plugins: { legend: { display: true, position: 'bottom' } }
            }
        });
    });
</script>
<script>
    function showConcert(concertId) {
        window.location.href = "{% url 'concert_detail' %}?concert_id=" + concertId;
    }
</script>
{% endblock scripts %}
