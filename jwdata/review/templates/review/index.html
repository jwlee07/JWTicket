{% extends "review/base.html" %}
{% load static %}

{% block content %}
<div class="d-flex" style="min-height: 100vh;">
    <!-- 사이드바 -->
    <nav id="sidebar" class="bg-dark text-white p-3" style="min-width:250px; transition: all 0.3s; overflow-x:hidden;">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h4 class="mb-0">공연 대시보드</h4>
        </div>

        <!-- 통합 -->
        {% if concerts %}
            <div class="mb-4">
                <h5>통합</h5>
                <div class="btn-group-vertical w-100 mt-2" role="group" aria-label="통합 바로가기">
                    <a href="{% url 'analyze_all_reviews' %}" class="btn btn-outline-light text-start">공연 리뷰</a>
                    <a href="{% url 'analyze_all_pattern' %}" class="btn btn-outline-light text-start">관람 패턴</a>
                    <a href="{% url 'analyze_all_seats' %}" class="btn btn-outline-light text-start">잔여 좌석</a>
                </div>
            </div>

            <!-- 장르별 공연 목록 -->
            <div class="mb-4">
                <h5>연극</h5>
                <div class="btn-group-vertical w-100 mt-2" role="group" aria-label="공연 선택">
                    {% for concert in concerts|dictsort:"name" %}
                        {% if concert.genre == '연극' %}
                            <button
                                class="btn btn-outline-light text-start {% if concert.id|stringformat:"s" == active_concert_id %}active{% endif %}" 
                                data-concert-id="{{ concert.id }}" 
                                onclick="showConcert('{{ concert.id }}')">
                                {{ concert.name }}
                            </button>
                        {% endif %}
                    {% endfor %}
                </div>
            </div>

            <div class="mb-4">
                <h5>뮤지컬</h5>
                <div class="btn-group-vertical w-100 mt-2" role="group" aria-label="공연 선택">
                    {% for concert in concerts|dictsort:"name" %}
                        {% if concert.genre == '뮤지컬' %}
                            <button
                                class="btn btn-outline-light text-start {% if concert.id|stringformat:"s" == active_concert_id %}active{% endif %}" 
                                data-concert-id="{{ concert.id }}" 
                                onclick="showConcert('{{ concert.id }}')">
                                {{ concert.name }}
                            </button>
                        {% endif %}
                    {% endfor %}
                </div>
            </div>

            <div class="mb-4">
                <h5>콘서트</h5>
                <div class="btn-group-vertical w-100 mt-2" role="group" aria-label="공연 선택">
                    {% for concert in concerts|dictsort:"name" %}
                        {% if concert.genre == '콘서트' %}
                            <button
                                class="btn btn-outline-light text-start {% if concert.id|stringformat:"s" == active_concert_id %}active{% endif %}" 
                                data-concert-id="{{ concert.id }}" 
                                onclick="showConcert('{{ concert.id }}')">
                                {{ concert.name }}
                            </button>
                        {% endif %}
                    {% endfor %}
                </div>
            </div>
        {% else %}
            <p class="mt-5 text-muted">현재 등록된 공연 정보가 없습니다.</p>
        {% endif %}
    </nav>

    <!-- 메인 컨텐츠 영역 -->
    <div class="flex-grow-1 p-3">
        <div class="d-flex justify-content-end mb-3">
            <a href="{% url 'update_sentiment' %}" class="btn btn-dark">ChatGPT 리뷰 감정</a>
        </div>

        <h3 class="mb-3">리뷰 평점</h3>

        <!-- 평점 요약 카드 섹션 -->
        <div class="row g-3 mb-4">
            <div class="col-12 col-md-6 col-lg-3">
                <div class="card shadow text-center">
                    <div class="card-body">
                        <h5 class="card-title">전체 평균 평점</h5>
                        <h3 class="card-text text-primary">{{ avg_all|floatformat:1|default:"0.0" }}/10</h3>
                        <p class="text-muted small mb-0">총 리뷰: {{ count_all|default:"0" }}건</p>
                    </div>
                </div>
            </div>

            <div class="col-12 col-md-6 col-lg-3">
                <div class="card shadow text-center">
                    <div class="card-body">
                        <h5 class="card-title">연극 평균 평점</h5>
                        <h3 class="card-text text-info">{{ avg_play|floatformat:1|default:"0.0" }}/10</h3>
                        <p class="text-muted small mb-0">연극 리뷰: {{ count_play|default:"0" }}건</p>
                    </div>
                </div>
            </div>

            <div class="col-12 col-md-6 col-lg-3">
                <div class="card shadow text-center">
                    <div class="card-body">
                        <h5 class="card-title">뮤지컬 평균 평점</h5>
                        <h3 class="card-text text-success">{{ avg_musical|floatformat:1|default:"0.0" }}/10</h3>
                        <p class="text-muted small mb-0">뮤지컬 리뷰: {{ count_musical|default:"0" }}건</p>
                    </div>
                </div>
            </div>

            <div class="col-12 col-md-6 col-lg-3">
                <div class="card shadow text-center">
                    <div class="card-body">
                        <h5 class="card-title">콘서트 평균 평점</h5>
                        <h3 class="card-text text-warning">{{ avg_concert|floatformat:1|default:"0.0" }}/10</h3>
                        <p class="text-muted small mb-0">콘서트 리뷰: {{ count_concert|default:"0" }}건</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- 리뷰 요약 (각 카테고리별 100% 가로폭) -->
        <div class="row">
            <h3 class="mb-3">리뷰 요약</h3>
            
            <!-- [전체] -->
            <div class="col-12 mb-3">
                <div class="card shadow h-100">
                    <div class="card-body">
                        <h5 class="card-title">[전체]</h5>
                        <div class="row align-items-center">
                            <div class="col-md-6 d-flex align-items-center justify-content-center">
                                {% if img_all %}
                                    <img src="data:image/png;base64,{{ img_all }}" 
                                        alt="전체 워드클라우드" 
                                        class="img-fluid" 
                                        style="max-height: 300px;">
                                {% else %}
                                    <p class="text-muted">데이터가 부족합니다.</p>
                                {% endif %}
                            </div>
                            <div class="col-md-6">
                                <canvas id="emotionChartAll" height="150"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- [연극] -->
            <div class="col-12 mb-3">
                <div class="card shadow h-100">
                    <div class="card-body">
                        <h5 class="card-title">[연극]</h5>
                        <div class="row align-items-center">
                            <div class="col-md-6 d-flex align-items-center justify-content-center">
                                {% if img_play %}
                                    <img src="data:image/png;base64,{{ img_play }}" 
                                        alt="연극 워드클라우드"
                                        class="img-fluid"
                                        style="max-height: 300px;">
                                {% else %}
                                    <p class="text-muted">연극 리뷰 데이터가 부족합니다.</p>
                                {% endif %}
                            </div>
                            <div class="col-md-6">
                                <canvas id="emotionChartPlay" height="150"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- [뮤지컬] -->
            <div class="col-12 mb-3">
                <div class="card shadow h-100">
                    <div class="card-body">
                        <h5 class="card-title">[뮤지컬]</h5>
                        <div class="row align-items-center">
                            <div class="col-md-6 d-flex align-items-center justify-content-center">
                                {% if img_musical %}
                                    <img src="data:image/png;base64,{{ img_musical }}" 
                                        alt="뮤지컬 워드클라우드"
                                        class="img-fluid"
                                        style="max-height: 300px;">
                                {% else %}
                                    <p class="text-muted">뮤지컬 리뷰 데이터가 부족합니다.</p>
                                {% endif %}
                            </div>
                            <div class="col-md-6">
                                <canvas id="emotionChartMusical" height="150"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- [콘서트] -->
            <div class="col-12 mb-3">
                <div class="card shadow h-100">
                    <div class="card-body">
                        <h5 class="card-title">[콘서트]</h5>
                        <div class="row align-items-center">
                            <div class="col-md-6 d-flex align-items-center justify-content-center">
                                {% if img_concert %}
                                    <img src="data:image/png;base64,{{ img_concert }}" 
                                        alt="콘서트 워드클라우드"
                                        class="img-fluid"
                                        style="max-height: 300px;">
                                {% else %}
                                    <p class="text-muted">콘서트 리뷰 데이터가 부족합니다.</p>
                                {% endif %}
                            </div>
                            <div class="col-md-6">
                                <canvas id="emotionChartConcert" height="150"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
        <!-- /리뷰 요약 -->
    </div>
</div>
{% endblock content %}

{% block scripts %}
<!-- Chart.js 라이브러리 로드 -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function () {
    // 감정 데이터
    const emotionAll = {{ emotion_all|safe }};
    const emotionPlay = {{ emotion_play|safe }};
    const emotionMusical = {{ emotion_musical|safe }};
    const emotionConcert = {{ emotion_concert|safe }};
    const emotionLabels = ["긍정", "부정", "중립"];

    // 가로 막대형 차트를 생성하는 함수
    function createHorizontalBarChart(ctxId, emotionData, title) {
        const ctx = document.getElementById(ctxId).getContext("2d");
        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: emotionLabels,
                datasets: [{
                    label: title,
                    data: [
                        emotionData.positive || 0, 
                        emotionData.negative || 0, 
                        emotionData.neutral || 0
                    ],
                    backgroundColor: [
                        'rgba(54, 162, 235, 0.6)',
                        'rgba(255, 99, 132, 0.6)',
                        'rgba(201, 203, 207, 0.6)'
                    ],
                    borderColor: [
                        'rgba(54, 162, 235, 1)',
                        'rgba(255, 99, 132, 1)',
                        'rgba(201, 203, 207, 1)'
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                indexAxis: 'y',
                responsive: true,
                scales: {
                    x: {
                        beginAtZero: true,
                        title: { display: true, text: '리뷰 수' }
                    },
                    y: {
                        title: { display: false }
                    }
                },
                plugins: {
                    legend: { display: false }
                }
            }
        });
    }

    // 각 차트 생성
    createHorizontalBarChart("emotionChartAll", emotionAll, "전체 감정");
    createHorizontalBarChart("emotionChartPlay", emotionPlay, "연극 감정");
    createHorizontalBarChart("emotionChartMusical", emotionMusical, "뮤지컬 감정");
    createHorizontalBarChart("emotionChartConcert", emotionConcert, "콘서트 감정");
});
</script>

<script>
    // 공연 정보 보기 (임시 함수)
    function showConcert(concertId) {
        alert("선택된 공연 ID: " + concertId);
    }
</script>
{% endblock scripts %}
