{% extends "review/base.html" %}
{% load static %}

{% block content %}
<div class="d-flex" style="min-height: 100vh;">
    <!-- 사이드바 -->
    <nav id="sidebar" class="bg-dark text-white p-3" style="min-width:250px; transition: all 0.3s; overflow-x:hidden;">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h4 class="mb-0">공연 대시보드</h4>
        </div>
        <!-- 통합 및 장르별 공연 목록 -->
        {% if concerts %}
            <div class="mb-4">
                <h5>통합</h5>
                <div class="btn-group-vertical w-100 mt-2" role="group" aria-label="통합 바로가기">
                    <a href="{% url 'analyze_all_reviews' %}" class="btn btn-outline-light text-start">공연 리뷰</a>
                    <a href="{% url 'analyze_all_pattern' %}" class="btn btn-outline-light text-start">관람 패턴</a>
                    <a href="{% url 'analyze_all_seats' %}" class="btn btn-outline-light text-start">잔여 좌석</a>
                </div>
            </div>
            <!-- 장르별 공연 목록 -->
            <div class="mb-4">
                <h5>연극</h5>
                <div class="btn-group-vertical w-100 mt-2" role="group" aria-label="공연 선택">
                    {% for concert in concerts|dictsort:"name" %}
                        {% if concert.genre == '연극' %}
                            <button
                                class="btn btn-outline-light text-start {% if concert.id|stringformat:"s" == active_concert_id %}active{% endif %}" 
                                data-concert-id="{{ concert.id }}" 
                                onclick="showConcert('{{ concert.id }}')">
                                {{ concert.name }}
                            </button>
                        {% endif %}
                    {% endfor %}
                </div>
            </div>

            <div class="mb-4">
                <h5>뮤지컬</h5>
                <div class="btn-group-vertical w-100 mt-2" role="group" aria-label="공연 선택">
                    {% for concert in concerts|dictsort:"name" %}
                        {% if concert.genre == '뮤지컬' %}
                            <button
                                class="btn btn-outline-light text-start {% if concert.id|stringformat:"s" == active_concert_id %}active{% endif %}" 
                                data-concert-id="{{ concert.id }}" 
                                onclick="showConcert('{{ concert.id }}')">
                                {{ concert.name }}
                            </button>
                        {% endif %}
                    {% endfor %}
                </div>
            </div>

            <div class="mb-4">
                <h5>콘서트</h5>
                <div class="btn-group-vertical w-100 mt-2" role="group" aria-label="공연 선택">
                    {% for concert in concerts|dictsort:"name" %}
                        {% if concert.genre == '콘서트' %}
                            <button
                                class="btn btn-outline-light text-start {% if concert.id|stringformat:"s" == active_concert_id %}active{% endif %}" 
                                data-concert-id="{{ concert.id }}" 
                                onclick="showConcert('{{ concert.id }}')">
                                {{ concert.name }}
                            </button>
                        {% endif %}
                    {% endfor %}
                </div>
            </div>
        {% else %}
            <p class="mt-5 text-muted">현재 등록된 공연 정보가 없습니다.</p>
        {% endif %}
    </nav>

    <!-- 메인 컨텐츠 영역 -->
    <div class="flex-grow-1 p-3">
        <!-- 우측 상단 버튼 (ChatGPT 감정 분석 업데이트) -->
        <div class="d-flex justify-content-end mb-3">
            <a href="{% url 'update_sentiment' %}" class="btn btn-dark me-2">ChatGPT 리뷰 감정 분석</a>
            <a href="{% url 'sync_db_to_sheet' %}" class="btn btn-success me-2">DB → Google Sheet</a>
            <a href="{% url 'sync_sheet_to_db' %}" class="btn btn-success me-2">Google Sheet → DB</a>
        </div>        

        <h3 class="mb-3">리뷰 평균 평점</h3>
        <!-- 평점 요약 카드 섹션 -->
        <div class="row g-3 mb-4">
            <div class="col-12 col-md-6 col-lg-3">
                <div class="card shadow text-center">
                    <div class="card-body">
                        <h5 class="card-title">전체 평균 평점</h5>
                        <h3 class="card-text text-primary">{{ avg_all|floatformat:1|default:"0.0" }}/10</h3>
                        <p class="text-muted small mb-0">총 리뷰: {{ count_all|default:"0" }}건</p>
                    </div>
                </div>
            </div>

            <div class="col-12 col-md-6 col-lg-3">
                <div class="card shadow text-center">
                    <div class="card-body">
                        <h5 class="card-title">연극 평균 평점</h5>
                        <h3 class="card-text text-info">{{ avg_play|floatformat:1|default:"0.0" }}/10</h3>
                        <p class="text-muted small mb-0">연극 리뷰: {{ count_play|default:"0" }}건</p>
                    </div>
                </div>
            </div>

            <div class="col-12 col-md-6 col-lg-3">
                <div class="card shadow text-center">
                    <div class="card-body">
                        <h5 class="card-title">뮤지컬 평균 평점</h5>
                        <h3 class="card-text text-success">{{ avg_musical|floatformat:1|default:"0.0" }}/10</h3>
                        <p class="text-muted small mb-0">뮤지컬 리뷰: {{ count_musical|default:"0" }}건</p>
                    </div>
                </div>
            </div>

            <div class="col-12 col-md-6 col-lg-3">
                <div class="card shadow text-center">
                    <div class="card-body">
                        <h5 class="card-title">콘서트 평균 평점</h5>
                        <h3 class="card-text text-warning">{{ avg_concert|floatformat:1|default:"0.0" }}/10</h3>
                        <p class="text-muted small mb-0">콘서트 리뷰: {{ count_concert|default:"0" }}건</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- 리뷰 요약 섹션 -->
        <div class="row">
            <h3 class="mb-3">리뷰 장르별 분석</h3>

            <!-- [전체] 섹션 -->
            <div class="col-12 mb-3">
                <div class="card shadow">
                    <div class="card-header">
                        <h5 class="card-title">[전체]</h5>
                    </div>
                    <div class="card-body">
                        <!-- 행 1: 전체 리뷰 워드클라우드 / 감정분석 그래프 -->
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header">
                                        <h6>모든 리뷰의 워드클라우드</h6>
                                    </div>
                                    <div class="card-body d-flex align-items-center justify-content-center">
                                        {% if img_all %}
                                            <img src="data:image/png;base64,{{ img_all }}" alt="전체 워드클라우드" class="img-fluid" style="max-height: 300px;">
                                        {% else %}
                                            <p class="text-muted">전체 리뷰 데이터가 부족합니다.</p>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header">
                                        <h6>감정분석 그래프</h6>
                                    </div>
                                    <div class="card-body">
                                        <canvas id="emotionChartAll" height="150"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- 행 2: 긍정 리뷰 워드클라우드 / 부정 리뷰 워드클라우드 -->
                        <div class="row">
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header">
                                        <h6>긍정 리뷰의 워드클라우드</h6>
                                    </div>
                                    <div class="card-body d-flex align-items-center justify-content-center">
                                        {% if img_all_positive %}
                                            <img src="data:image/png;base64,{{ img_all_positive }}" alt="전체 긍정 워드클라우드" class="img-fluid" style="max-height: 300px;">
                                        {% else %}
                                            <p class="text-muted">긍정 리뷰 데이터가 부족합니다.</p>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header">
                                        <h6>부정 리뷰의 워드클라우드</h6>
                                    </div>
                                    <div class="card-body d-flex align-items-center justify-content-center">
                                        {% if img_all_negative %}
                                            <img src="data:image/png;base64,{{ img_all_negative }}" alt="전체 부정 워드클라우드" class="img-fluid" style="max-height: 300px;">
                                        {% else %}
                                            <p class="text-muted">부정 리뷰 데이터가 부족합니다.</p>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- [연극] 섹션 -->
            <div class="col-12 mb-3">
                <div class="card shadow">
                    <div class="card-header">
                        <h5 class="card-title">[연극]</h5>
                    </div>
                    <div class="card-body">
                        <!-- 행 1: 전체 리뷰 워드클라우드 / 감정분석 그래프 -->
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header">
                                        <h6>모든 리뷰의 워드클라우드</h6>
                                    </div>
                                    <div class="card-body d-flex align-items-center justify-content-center">
                                        {% if img_play %}
                                            <img src="data:image/png;base64,{{ img_play }}" alt="연극 전체 워드클라우드" class="img-fluid" style="max-height: 300px;">
                                        {% else %}
                                            <p class="text-muted">전체 리뷰 데이터가 부족합니다.</p>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header">
                                        <h6>감정분석 그래프</h6>
                                    </div>
                                    <div class="card-body">
                                        <canvas id="emotionChartPlay" height="150"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- 행 2: 긍정 리뷰 워드클라우드 / 부정 리뷰 워드클라우드 -->
                        <div class="row">
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header">
                                        <h6>긍정 리뷰의 워드클라우드</h6>
                                    </div>
                                    <div class="card-body d-flex align-items-center justify-content-center">
                                        {% if img_play_positive %}
                                            <img src="data:image/png;base64,{{ img_play_positive }}" alt="연극 긍정 워드클라우드" class="img-fluid" style="max-height: 300px;">
                                        {% else %}
                                            <p class="text-muted">긍정 리뷰 데이터가 부족합니다.</p>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header">
                                        <h6>부정 리뷰의 워드클라우드</h6>
                                    </div>
                                    <div class="card-body d-flex align-items-center justify-content-center">
                                        {% if img_play_negative %}
                                            <img src="data:image/png;base64,{{ img_play_negative }}" alt="연극 부정 워드클라우드" class="img-fluid" style="max-height: 300px;">
                                        {% else %}
                                            <p class="text-muted">부정 리뷰 데이터가 부족합니다.</p>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- [뮤지컬] 섹션 -->
            <div class="col-12 mb-3">
                <div class="card shadow">
                    <div class="card-header">
                        <h5 class="card-title">[뮤지컬]</h5>
                    </div>
                    <div class="card-body">
                        <!-- 행 1: 전체 리뷰 워드클라우드 / 감정분석 그래프 -->
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header">
                                        <h6>모든 리뷰의 워드클라우드</h6>
                                    </div>
                                    <div class="card-body d-flex align-items-center justify-content-center">
                                        {% if img_musical %}
                                            <img src="data:image/png;base64,{{ img_musical }}" alt="뮤지컬 전체 워드클라우드" class="img-fluid" style="max-height: 300px;">
                                        {% else %}
                                            <p class="text-muted">전체 리뷰 데이터가 부족합니다.</p>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header">
                                        <h6>감정분석 그래프</h6>
                                    </div>
                                    <div class="card-body">
                                        <canvas id="emotionChartMusical" height="150"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- 행 2: 긍정 리뷰 워드클라우드 / 부정 리뷰 워드클라우드 -->
                        <div class="row">
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header">
                                        <h6>긍정 리뷰의 워드클라우드</h6>
                                    </div>
                                    <div class="card-body d-flex align-items-center justify-content-center">
                                        {% if img_musical_positive %}
                                            <img src="data:image/png;base64,{{ img_musical_positive }}" alt="뮤지컬 긍정 워드클라우드" class="img-fluid" style="max-height: 300px;">
                                        {% else %}
                                            <p class="text-muted">긍정 리뷰 데이터가 부족합니다.</p>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header">
                                        <h6>부정 리뷰의 워드클라우드</h6>
                                    </div>
                                    <div class="card-body d-flex align-items-center justify-content-center">
                                        {% if img_musical_negative %}
                                            <img src="data:image/png;base64,{{ img_musical_negative }}" alt="뮤지컬 부정 워드클라우드" class="img-fluid" style="max-height: 300px;">
                                        {% else %}
                                            <p class="text-muted">부정 리뷰 데이터가 부족합니다.</p>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- [콘서트] 섹션 -->
            <div class="col-12 mb-3">
                <div class="card shadow">
                    <div class="card-header">
                        <h5 class="card-title">[콘서트]</h5>
                    </div>
                    <div class="card-body">
                        <!-- 행 1: 전체 리뷰 워드클라우드 / 감정분석 그래프 -->
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header">
                                        <h6>모든 리뷰의 워드클라우드</h6>
                                    </div>
                                    <div class="card-body d-flex align-items-center justify-content-center">
                                        {% if img_concert %}
                                            <img src="data:image/png;base64,{{ img_concert }}" alt="콘서트 전체 워드클라우드" class="img-fluid" style="max-height: 300px;">
                                        {% else %}
                                            <p class="text-muted">전체 리뷰 데이터가 부족합니다.</p>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header">
                                        <h6>감정분석 그래프</h6>
                                    </div>
                                    <div class="card-body">
                                        <canvas id="emotionChartConcert" height="150"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- 행 2: 긍정 리뷰 워드클라우드 / 부정 리뷰 워드클라우드 -->
                        <div class="row">
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header">
                                        <h6>긍정 리뷰의 워드클라우드</h6>
                                    </div>
                                    <div class="card-body d-flex align-items-center justify-content-center">
                                        {% if img_concert_positive %}
                                            <img src="data:image/png;base64,{{ img_concert_positive }}" alt="콘서트 긍정 워드클라우드" class="img-fluid" style="max-height: 300px;">
                                        {% else %}
                                            <p class="text-muted">긍정 리뷰 데이터가 부족합니다.</p>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header">
                                        <h6>부정 리뷰의 워드클라우드</h6>
                                    </div>
                                    <div class="card-body d-flex align-items-center justify-content-center">
                                        {% if img_concert_negative %}
                                            <img src="data:image/png;base64,{{ img_concert_negative }}" alt="콘서트 부정 워드클라우드" class="img-fluid" style="max-height: 300px;">
                                        {% else %}
                                            <p class="text-muted">부정 리뷰 데이터가 부족합니다.</p>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
        <!-- /리뷰 요약 섹션 -->
    </div>
</div>
{% endblock content %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function () {
    // 감정 데이터
    const emotionAll = {{ emotion_all|safe }};
    const emotionPlay = {{ emotion_play|safe }};
    const emotionMusical = {{ emotion_musical|safe }};
    const emotionConcert = {{ emotion_concert|safe }};
    const emotionLabels = ["긍정", "부정", "중립"];

    function createHorizontalBarChart(ctxId, emotionData, title) {
        const ctx = document.getElementById(ctxId).getContext("2d");
        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: emotionLabels,
                datasets: [{
                    label: title,
                    data: [
                        emotionData.positive || 0, 
                        emotionData.negative || 0, 
                        emotionData.neutral || 0
                    ],
                    backgroundColor: [
                        'rgba(54, 162, 235, 0.6)',
                        'rgba(255, 99, 132, 0.6)',
                        'rgba(201, 203, 207, 0.6)'
                    ],
                    borderColor: [
                        'rgba(54, 162, 235, 1)',
                        'rgba(255, 99, 132, 1)',
                        'rgba(201, 203, 207, 1)'
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                indexAxis: 'y',
                responsive: true,
                scales: {
                    x: {
                        beginAtZero: true,
                        title: { display: true, text: '리뷰 수' }
                    },
                    y: {
                        title: { display: false }
                    }
                },
                plugins: {
                    legend: { display: false }
                }
            }
        });
    }

    createHorizontalBarChart("emotionChartAll", emotionAll, "전체 감정");
    createHorizontalBarChart("emotionChartPlay", emotionPlay, "연극 감정");
    createHorizontalBarChart("emotionChartMusical", emotionMusical, "뮤지컬 감정");
    createHorizontalBarChart("emotionChartConcert", emotionConcert, "콘서트 감정");
});
</script>
<script>
    function showConcert(concertId) {
        window.location.href = "{% url 'concert_detail' %}?concert_id=" + concertId;
    }
</script>
{% endblock scripts %}
