{% extends "review/base.html" %}
{% block content %}
<div class="container-fluid py-4" style="min-height: 100vh;">
    <div class="content-container">
        <!-- 페이지 제목 -->
        <h1 class="text-center mb-4">잔여 좌석 현황</h1>

        <!-- 필터 섹션 -->
        <div class="card p-4 shadow-sm mb-5">
            <h2 class="mb-3">조건 선택</h2>
            <form method="GET" class="row g-3">
                <!-- 공연 선택 -->
                <div class="col-lg-3 col-md-6 col-sm-12">
                    <label for="concert" class="form-label">공연명</label>
                    <select id="concert" name="concert" class="form-control">
                        <option value="">-- 공연 선택 --</option>
                        {% for concert in all_concerts %}
                        <option value="{{ concert }}" {% if concert == selected_concert %}selected{% endif %}>
                            {{ concert }}
                        </option>
                        {% endfor %}
                    </select>
                </div>

                <!-- 조회 버튼 -->
                <div class="col-lg-3 col-md-6 col-sm-12 d-grid">
                    <label class="form-label invisible">조회 버튼</label>
                    <button type="submit" class="btn btn-dark btn-block">조회</button>
                </div>
            </form>
        </div>

        <!-- 조건 분기: 공연이 선택되었을 때 seat_data 표시 -->
        {% if selected_concert %}
            {% if seat_data %}
                <!-- 좌석 현황 섹션 -->
                <div class="card p-4 shadow-sm mb-5">
                    <h2 class="mb-3">잔여 좌석 현황</h2>
                    <!-- 그래프들을 담을 그리드 컨테이너 -->
                    <div class="row g-4" id="chartsContainer">
                        <!-- JavaScript에서 생성 -->
                    </div>
                </div>
            {% else %}
                <!-- 공연은 선택되었지만 seat_data가 비었을 때 -->
                <p class="text-center text-muted mt-5">조건에 맞는 좌석 데이터가 없습니다.</p>
            {% endif %}
        {% else %}
            <!-- 공연을 선택하지 않았을 때 -->
            <p class="text-center text-muted mt-5">공연을 선택해주세요.</p>
        {% endif %}
    </div>
</div>
{% endblock %}
{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // 그래프 개수를 설정하는 변수
        const chartsPerRow = 2; // 한 행에 배치할 그래프 개수

        // 부트스트랩 컬럼 클래스를 반환하는 함수
        function getBootstrapColumnClasses(perRow) {
            const columns = {
                1: 'col-lg-12 col-md-12 col-sm-12',
                2: 'col-lg-6 col-md-6 col-sm-12',
                3: 'col-lg-4 col-md-6 col-sm-12',
                4: 'col-lg-3 col-md-4 col-sm-6',
                // 필요에 따라 더 추가 가능
            };
            return columns[perRow] || 'col-lg-6 col-md-6 col-sm-12'; // 기본값: 2개
        }

        // seat_data를 기반으로 차트를 렌더링하기 위한 준비
        const seatData = [
            {% for item in seat_data %}
            {
                seatClass: "{{ item.seat_class }}",
                seatCount: {{ item.seat_count }},
                createdAt: "{{ item.created_at|date:"Y년 m월 d일 H시" }}",
                roundName: "{{ item.round_name }}",
                date: "{{ item.date }}",
                dayStr: "{{ item.day_str }}"
            },
            {% endfor %}
        ];

        // 좌석 등급별로 다른 색상으로 표시
        const colors = {
            "VIP석": "#FF6384",
            "R석": "#36A2EB",
            "S석": "#FFCE56",
            "A석": "#4BC0C0",
            "B석": "#9966FF"
        };

        // 그래프들을 생성할 그리드 컨테이너
        const chartsContainer = document.getElementById('chartsContainer');

        // 데이터 그룹화: 날짜별로
        const dataGroupedByDate = {};
        seatData.forEach(item => {
            if (!dataGroupedByDate[item.date]) {
                dataGroupedByDate[item.date] = [];
            }
            dataGroupedByDate[item.date].push(item);
        });

        // 저장된 차트 인스턴스
        const chartInstances = {};

        // 함수: 회차별 데이터 필터링
        function filterDataByRound(data, selectedRound) {
            if (!selectedRound) {
                return data;
            }
            return data.filter(item => item.roundName === selectedRound);
        }

        // 함수: 회차별, 좌석등급별 데이터 집계
        function aggregateData(data) {
            const grouped = {};
            data.forEach(item => {
                const key = `${item.roundName} - ${item.createdAt}`;
                if (!grouped[key]) {
                    grouped[key] = {};
                }
                if (!grouped[key][item.seatClass]) {
                    grouped[key][item.seatClass] = 0;
                }
                grouped[key][item.seatClass] += item.seatCount;
            });
            return grouped;
        }

        // 함수: 그래프 생성
        function createChart(date, groupedData, canvasId) {
            const labels = Object.keys(groupedData);

            // 좌석 등급별로 데이터가 있는지 확인 후, 있는 경우에만 dataset 생성
            const availableSeatClasses = Object.keys(colors).filter(seatClass => {
                return labels.some(label => groupedData[label][seatClass] > 0);
            });

            if (availableSeatClasses.length === 0) {
                // 데이터가 없는 경우 그래프 생성하지 않음
                return null;
            }

            const datasets = availableSeatClasses.map(seatClass => ({
                label: seatClass,
                data: labels.map(label => groupedData[label][seatClass] || 0),
                borderColor: colors[seatClass],
                backgroundColor: colors[seatClass],
                fill: false,
                tension: 0.1
            }));

            const ctx = document.getElementById(canvasId).getContext('2d');
            const chart = new Chart(ctx, {
                type: 'line', // 그래프 타입을 'line'으로 변경
                data: {
                    labels: labels,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: { 
                            title: { display: true, text: '회차 - 수집 시간' },
                            ticks: {
                                maxRotation: 90,
                                minRotation: 45
                            }
                        },
                        y: { 
                            title: { display: true, text: '좌석 수' }, 
                            beginAtZero: true 
                        }
                    },
                    plugins: { 
                        legend: { display: true, position: 'top' },
                        title: {
                            display: true,
                            text: `${date} 좌석 현황`
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false
                        }
                    },
                    interaction: {
                        mode: 'nearest',
                        axis: 'x',
                        intersect: false
                    }
                }
            });

            return chart;
        }

        // 함수: 차트 업데이트
        function updateChart(event) {
            const filter = event.target;
            const date = filter.getAttribute('data-date');
            const selectedRound = filter.value || '1회'; // 기본값을 '1회'로 설정
            const filteredData = filterDataByRound(dataGroupedByDate[date], selectedRound);
            const groupedData = aggregateData(filteredData);
            const canvasId = `seatChart_${date}`;

            // 해당 날짜의 차트 인스턴스 찾기
            const chart = chartInstances[canvasId];
            if (chart) {
                // 새로운 데이터를 기반으로 그래프 업데이트
                const newLabels = Object.keys(groupedData);
                
                // 좌석 등급별로 데이터가 있는지 확인 후, 있는 경우에만 dataset 생성
                const availableSeatClasses = Object.keys(colors).filter(seatClass => {
                    return newLabels.some(label => groupedData[label][seatClass] > 0);
                });

                // 기존 차트의 datasets을 새로운 데이터로 교체
                chart.data.labels = newLabels;
                chart.data.datasets = availableSeatClasses.map(seatClass => ({
                    label: seatClass,
                    data: newLabels.map(label => groupedData[label][seatClass] || 0),
                    borderColor: colors[seatClass],
                    backgroundColor: colors[seatClass],
                    fill: false,
                    tension: 0.1
                }));
                chart.options.plugins.title.text = `${date} 좌석 현황`;
                chart.update();
            }
        }

        // 함수: 초기 그래프 생성
        function initializeCharts() {
            for (const date in dataGroupedByDate) {
                const dateData = dataGroupedByDate[date];

                // '1회' 데이터만 필터링
                const filteredData = filterDataByRound(dateData, '1회');
                const groupedData = aggregateData(filteredData);

                if (Object.keys(groupedData).length === 0) {
                    // '1회' 데이터가 없는 경우 그래프 생성하지 않음
                    continue;
                }

                const firstItem = dateData.find(item => item.roundName === '1회') || dateData[0];

                // 부트스트랩 컬럼 클래스 결정
                const columnClasses = getBootstrapColumnClasses(chartsPerRow);

                // 컬럼 생성
                const colDiv = document.createElement('div');
                colDiv.className = columnClasses;

                // 카드 생성
                const cardDiv = document.createElement('div');
                cardDiv.classList.add('card', 'h-100', 'shadow-sm');

                // 카드 헤더: 제목과 회차 선택 필터
                const cardHeader = document.createElement('div');
                cardHeader.classList.add('card-header', 'd-flex', 'justify-content-between', 'align-items-center');

                // 제목
                const title = document.createElement('h5');
                title.classList.add('mb-0');
                title.textContent = `${firstItem.date} (${firstItem.dayStr})`;
                cardHeader.appendChild(title);

                // 회차 선택 필터
                const filterDiv = document.createElement('div');
                filterDiv.classList.add('form-group', 'mb-0');

                const select = document.createElement('select');
                select.classList.add('form-select', 'round-filter');
                select.setAttribute('data-date', date);

                // '1회'를 기본 선택으로 설정
                const option1 = document.createElement('option');
                option1.value = '1회';
                option1.textContent = '1회';
                option1.selected = true;
                select.appendChild(option1);

                // 해당 날짜의 유니크한 회차만 추가 (1회를 제외한 나머지)
                const uniqueRounds = [...new Set(dateData.map(item => item.roundName))].sort();
                uniqueRounds.forEach(round => {
                    if (round !== '1회') { // '1회'는 이미 기본 선택으로 추가
                        const option = document.createElement('option');
                        option.value = round;
                        option.textContent = round;
                        select.appendChild(option);
                    }
                });

                filterDiv.appendChild(select);
                cardHeader.appendChild(filterDiv);

                cardDiv.appendChild(cardHeader);

                // 카드 바디: 그래프 캔버스
                const cardBody = document.createElement('div');
                cardBody.classList.add('card-body', 'p-3');

                const canvas = document.createElement('canvas');
                canvas.id = `seatChart_${date}`;
                canvas.style.height = '300px'; // 고정 높이 설정

                cardBody.appendChild(canvas);
                cardDiv.appendChild(cardBody);

                // 카드를 컬럼에 추가
                colDiv.appendChild(cardDiv);
                chartsContainer.appendChild(colDiv);

                // 그래프 생성
                const chart = createChart(firstItem.date, groupedData, `seatChart_${date}`);
                if (chart) {
                    chartInstances[`seatChart_${date}`] = chart;
                }
            }
        }

        // 함수: 이벤트 리스너 추가
        function addEventListeners() {
            const filters = document.querySelectorAll('.round-filter');
            filters.forEach(filter => {
                filter.addEventListener('change', updateChart);
            });
        }

        // 초기화 및 이벤트 리스너 등록
        initializeCharts();
        addEventListeners();
    });
</script>
{% endblock scripts %}
