{% extends "review/base.html" %}
{% block content %}
<div class="container-fluid py-4" style="min-height: 100vh;">
    <div class="content-container">
        <!-- 페이지 제목 -->
        <h1 class="text-center mb-4">잔여 좌석 현황</h1>

        <!-- 필터 섹션 -->
        <div class="card p-4 shadow-sm mb-5">
            <h2 class="mb-3">조건 선택</h2>
            <form method="GET" class="row g-3">
                <!-- 공연 선택 -->
                <div class="col-lg-3 col-md-6 col-sm-12">
                    <label for="concert" class="form-label">공연명</label>
                    <select id="concert" name="concert" class="form-control">
                        <option value="">-- 공연 선택 --</option>
                        {% for concert in all_concerts %}
                        <option value="{{ concert }}" {% if concert == selected_concert %}selected{% endif %}>
                            {{ concert }}
                        </option>
                        {% endfor %}
                    </select>
                </div>

                <!-- 조회 버튼 -->
                <div class="col-lg-3 col-md-6 col-sm-12 d-grid">
                    <label class="form-label invisible">조회 버튼</label>
                    <button type="submit" class="btn btn-dark btn-block">조회</button>
                </div>
            </form>
        </div>

        <!-- 조건 분기: 공연이 선택되었을 때 seat_data 표시 -->
        {% if selected_concert %}
            {% if seat_data %}
                <!-- 좌석 현황 섹션 -->
                <div class="card p-4 shadow-sm mb-5">
                    <h2 class="mb-3">잔여 좌석 현황</h2>
                    <!-- 그래프들을 담을 그리드 컨테이너 -->
                    <div class="row g-4" id="chartsContainer">
                        <!-- JavaScript에서 생성 -->
                    </div>
                </div>
            {% else %}
                <!-- 공연은 선택되었지만 seat_data가 비었을 때 -->
                <p class="text-center text-muted mt-5">조건에 맞는 좌석 데이터가 없습니다.</p>
            {% endif %}
        {% else %}
            <!-- 공연을 선택하지 않았을 때 -->
            <p class="text-center text-muted mt-5">공연을 선택해주세요.</p>
        {% endif %}
    </div>
</div>
{% endblock %}
{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // 그래프 개수를 설정하는 변수
    const chartsPerRow = 2; // 한 행에 배치할 그래프 개수

    // 부트스트랩 컬럼 클래스를 반환하는 함수
    function getBootstrapColumnClasses(perRow) {
        const columns = {
            1: 'col-lg-12 col-md-12 col-sm-12',
            2: 'col-lg-6 col-md-6 col-sm-12',
            3: 'col-lg-4 col-md-6 col-sm-12',
            4: 'col-lg-3 col-md-4 col-sm-6',
            // 필요에 따라 더 추가 가능
        };
        return columns[perRow] || 'col-lg-6 col-md-6 col-sm-12'; // 기본값: 2개
    }

    // seat_data를 기반으로 차트를 렌더링하기 위한 준비
    const seatData = [
        {% for item in seat_data %}
        {
            seatClass: "{{ item.seat_class }}",
            seatCount: {{ item.seat_count }},
            createdAt: "{{ item.created_at|date:"Y년 m월 d일 H시" }}",
            roundName: "{{ item.round_name }}",
            date: "{{ item.date }}",
            dayStr: "{{ item.day_str }}"
        },
        {% endfor %}
    ];

    // 좌석 등급별로 다른 색상으로 표시
    const colors = {
        "VIP석": "#FF6384",
        "R석": "#36A2EB",
        "S석": "#FFCE56",
        "A석": "#4BC0C0",
        "B석": "#9966FF"
    };

    // 그래프들을 생성할 그리드 컨테이너
    const chartsContainer = document.getElementById('chartsContainer');

    // 데이터 그룹화: 날짜별로
    const dataGroupedByDate = {};
    seatData.forEach(item => {
        if (!dataGroupedByDate[item.date]) {
            dataGroupedByDate[item.date] = [];
        }
        dataGroupedByDate[item.date].push(item);
    });

    // 함수: 회차별 데이터 필터링
    function filterDataByRound(data, selectedRound) {
        if (!selectedRound) {
            return data;
        }
        return data.filter(item => item.roundName === selectedRound);
    }

    // 함수: 회차별, 좌석등급별 데이터 집계
    function aggregateData(data) {
        const grouped = {};
        data.forEach(item => {
            const key = `${item.roundName} - ${item.createdAt}`;
            if (!grouped[key]) {
                grouped[key] = {};
            }
            if (!grouped[key][item.seatClass]) {
                grouped[key][item.seatClass] = 0;
            }
            grouped[key][item.seatClass] += item.seatCount;
        });
        return grouped;
    }

    // 함수: 그래프 생성
    function createChart(date, groupedData, canvasId) {
        const labels = Object.keys(groupedData);
        const datasets = Object.keys(colors).map(seatClass => ({
            label: seatClass,
            data: labels.map(label => groupedData[label][seatClass] || 0),
            backgroundColor: colors[seatClass]
        }));

        const ctx = document.getElementById(canvasId).getContext('2d');
        const chart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: datasets
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: { 
                        title: { display: true, text: '회차 - 수집 시간' },
                        ticks: {
                            maxRotation: 90,
                            minRotation: 45
                        }
                    },
                    y: { 
                        title: { display: true, text: '좌석 수' }, 
                        beginAtZero: true 
                    }
                },
                plugins: { 
                    legend: { display: true, position: 'top' },
                    title: {
                        display: true,
                        text: `${date} 좌석 현황`
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false
                    }
                },
                interaction: {
                    mode: 'nearest',
                    axis: 'x',
                    intersect: false
                }
            }
        });

        return chart;
    }

    // 저장된 차트 인스턴스
    const chartInstances = {};

    // 함수: 차트 업데이트
    function updateChart(event) {
        const filter = event.target;
        const date = filter.getAttribute('data-date');
        const selectedRound = filter.value;
        const filteredData = filterDataByRound(dataGroupedByDate[date], selectedRound);
        const groupedData = aggregateData(filteredData);
        const canvasId = `seatChart_${date}`;

        // 해당 날짜의 차트 인스턴스 찾기
        const chart = chartInstances[canvasId];
        if (chart) {
            // 라벨과 데이터 업데이트
            chart.data.labels = Object.keys(groupedData);
            chart.data.datasets.forEach(dataset => {
                dataset.data = chart.data.labels.map(label => groupedData[label][dataset.label] || 0);
            });
            chart.options.plugins.title.text = `${date} 좌석 현황`;
            chart.update();
        }
    }

    // 함수: 초기 그래프 생성
    function initializeCharts() {
        for (const date in dataGroupedByDate) {
            const dateData = dataGroupedByDate[date];
            const firstItem = dateData[0];

            // 부트스트랩 컬럼 클래스 결정
            const columnClasses = getBootstrapColumnClasses(chartsPerRow);

            // 컬럼 생성
            const colDiv = document.createElement('div');
            colDiv.className = columnClasses;

            // 카드 생성
            const cardDiv = document.createElement('div');
            cardDiv.classList.add('card', 'h-100', 'shadow-sm');

            // 카드 헤더: 제목과 회차 선택 필터
            const cardHeader = document.createElement('div');
            cardHeader.classList.add('card-header', 'd-flex', 'justify-content-between', 'align-items-center');

            // 제목
            const title = document.createElement('h5');
            title.classList.add('mb-0');
            title.textContent = `${firstItem.date} (${firstItem.dayStr})`;
            cardHeader.appendChild(title);

            // 회차 선택 필터
            const filterDiv = document.createElement('div');
            filterDiv.classList.add('form-group', 'mb-0');

            const select = document.createElement('select');
            select.classList.add('form-select', 'round-filter');
            select.setAttribute('data-date', date);

            const defaultOption = document.createElement('option');
            defaultOption.value = '';
            defaultOption.textContent = '-- 모든 회차 --';
            select.appendChild(defaultOption);

            // 해당 날짜의 유니크한 회차만 추가
            const uniqueRounds = [...new Set(dateData.map(item => item.roundName))].sort();
            uniqueRounds.forEach(round => {
                const option = document.createElement('option');
                option.value = round;
                option.textContent = round;
                select.appendChild(option);
            });

            filterDiv.appendChild(select);
            cardHeader.appendChild(filterDiv);

            cardDiv.appendChild(cardHeader);

            // 카드 바디: 그래프 캔버스
            const cardBody = document.createElement('div');
            cardBody.classList.add('card-body', 'p-3');

            const canvas = document.createElement('canvas');
            canvas.id = `seatChart_${date}`;
            canvas.style.height = '300px'; // 고정 높이 설정

            cardBody.appendChild(canvas);
            cardDiv.appendChild(cardBody);

            // 카드를 컬럼에 추가
            colDiv.appendChild(cardDiv);
            chartsContainer.appendChild(colDiv);

            // 초기 그래프 생성
            const groupedData = aggregateData(dateData);
            chartInstances[`seatChart_${date}`] = createChart(date, groupedData, `seatChart_${date}`);
        }
    }

    // 함수: 이벤트 리스너 추가
    function addEventListeners() {
        const filters = document.querySelectorAll('.round-filter');
        filters.forEach(filter => {
            filter.addEventListener('change', updateChart);
        });
    }

    // DOM Content Loaded
    document.addEventListener('DOMContentLoaded', function() {
        initializeCharts();
        addEventListeners();
    });
</script>
{% endblock scripts %}
