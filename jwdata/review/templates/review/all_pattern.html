<!-- all_pattern.html -->
{% extends "review/base.html" %}
{% load static %}

{% block content %}
<div class="container-fluid py-4" style="min-height: 100vh;">
    <div class="content-container">

        <!-- 페이지 제목 -->
        <h1 class="text-center mb-5">공연 관람 패턴 분석</h1>

        <!-- 공연 조합별 관객 분포 파이 차트 -->
        {% if combination_counts %}
        <div class="mt-5">
            <h2>공연 조합별 관객 분포</h2>
            <div class="card p-3">
                <canvas id="combinationChart" style="max-width: 100%; max-height: 500px;"></canvas>
            </div>
        </div>
        {% else %}
        <p class="text-muted mt-5">공연 조합별 관객 데이터가 없습니다.</p>
        {% endif %}

        <!-- 닉네임 별 관람 패턴 테이블 -->
        {% if common_nicknames %}
        <div class="mt-5">
            <h2>닉네임 별 관람 패턴</h2>
            <table class="table table-bordered table-hover mt-3">
                <thead class="table-dark">
                    <tr>
                        <th>닉네임</th>
                        <th>관람 공연</th>
                        <th>관람 공연 수</th>
                    </tr>
                </thead>
                <tbody>
                    {% for nickname, concerts in common_nicknames.items %}
                    <tr>
                        <td>{{ nickname }}</td>
                        <td>
                            {% for concert in concerts %}
                                {{ concert.concert }}({{ concert.date }})
                                {% if not forloop.last %} → {% endif %}
                            {% endfor %}
                        </td>
                        <td>{{ concerts|length }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <p class="text-muted mt-5">닉네임 별 관람 패턴 데이터가 없습니다.</p>
        {% endif %}
    </div>
</div>
{% endblock content %}

{% block scripts %}
<!-- Chart.js 라이브러리 로드 -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function () {
    {% if combination_counts %}
    // 공연 조합별 관객 분포 차트 생성
    const ctxCombination = document.getElementById('combinationChart').getContext('2d');
    
    // Django 템플릿에서 데이터를 직접 전달
    const combinationLabels = [
        {% for combo in combination_counts.keys %}
            '{{ combo }}',
        {% endfor %}
    ];
    const combinationData = [
        {% for count in combination_counts.values %}
            {{ count }},
        {% endfor %}
    ];
    
    // 색상 팔레트 (최대 10개의 색상)
    const backgroundColors = [
        'rgba(255, 99, 132, 0.6)',
        'rgba(54, 162, 235, 0.6)',
        'rgba(255, 206, 86, 0.6)',
        'rgba(75, 192, 192, 0.6)',
        'rgba(153, 102, 255, 0.6)',
        'rgba(255, 159, 64, 0.6)',
        'rgba(199, 199, 199, 0.6)',
        'rgba(83, 102, 255, 0.6)',
        'rgba(255, 99, 255, 0.6)',
        'rgba(99, 255, 132, 0.6)'
    ];
    
    // 차트 데이터 설정
    const dataCombinationChart = {
        labels: combinationLabels,
        datasets: [{
            data: combinationData,
            backgroundColor: backgroundColors.slice(0, combinationLabels.length),
            borderColor: backgroundColors.slice(0, combinationLabels.length).map(color => color.replace('0.6', '1')),
            borderWidth: 1
        }]
    };
    
    // 차트 옵션 설정
    const optionsCombinationChart = {
        responsive: true,
        plugins: {
            legend: {
                position: 'top',
            },
            title: {
                display: true,
                text: '공연 조합별 관객 분포'
            },
            tooltip: {
                callbacks: {
                    // 툴팁에 "명" 단위 표시
                    label: function(context) {
                        const label = context.label || '';
                        const value = context.raw || 0;
                        return `${label}: ${value}명`;
                    }
                }
            }
        }
    };
    
    // 차트 생성
    new Chart(ctxCombination, {
        type: 'pie',
        data: dataCombinationChart,
        options: optionsCombinationChart
    });
    {% endif %}
});
</script>
{% endblock scripts %}
