{% extends "review/base.html" %}
{% load static %}

{% block content %}
<div class="container-fluid py-4" style="min-height: 100vh;">
    <div class="content-container">

        <!-- 페이지 제목 -->
        <h1 class="text-center mb-5">공연 관람 패턴 분석</h1>

        <!-- 각 공연별 첫 공연 샌키 다이어그램 -->
        {% if all_concerts and filtered_common_nicknames %}
        {% for concert_name, sankey_data in filtered_common_nicknames.items %}
        <div class="mt-5">
            <h2>{{ concert_name }}를 첫 공연으로 한 관람 패턴</h2>
            <div class="card p-3">
                <div id="sankeyChart_{{ forloop.counter }}" style="width: 100%; height: 600px;"></div>
            </div>
        </div>
        {% endfor %}
        {% else %}
        <p class="text-muted mt-5">데이터가 없습니다.</p>
        {% endif %}

        {% if combination_counts %}
        <div class="mt-5">
            <h2>공연 조합별 관객 분포</h2>
            <div class="card p-3">
                <!-- 파이 차트를 표시할 캔버스 -->
                <canvas id="combinationChart" style="max-width: 100%; max-height: 500px;"></canvas>
            </div>
        </div>
        {% else %}
        <p class="text-muted mt-5">공연 조합별 관객 데이터가 없습니다.</p>
        {% endif %}

        {% if common_nicknames %}
        <div class="mt-5">
            <h2>닉네임 별 관람 패턴</h2>
            <table class="table table-bordered table-hover mt-3">
                <thead class="table-dark">
                    <tr>
                        <th>닉네임</th>
                        <th>관람 공연</th>
                        <th>관람 공연 수</th>
                    </tr>
                </thead>
                <tbody>
                    {% for nickname, concerts in common_nicknames.items %}
                    <tr>
                        <td>{{ nickname }}</td>
                        <td>
                            {% for c in concerts %}
                                {{ c.concert }}({{ c.date }})
                                {% if not forloop.last %} → {% endif %}
                            {% endfor %}
                        </td>
                        <td>{{ concerts|length }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <p class="text-muted mt-5">닉네임 별 관람 패턴 데이터가 없습니다.</p>
        {% endif %}
    </div>
</div>
{% endblock content %}

{% block scripts %}
<!-- Chart.js 라이브러리 로드 -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<!-- Plotly.js 라이브러리 로드 -->
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function () {
    // 샌키 다이어그램
    {% if filtered_common_nicknames %}
    {% for concert_name, sankey_data in filtered_common_nicknames.items %}
    // {{ concert_name }}를 첫 공연으로 한 샌키 다이어그램 데이터
    const sankeyData_{{ forloop.counter }} = {{ sankey_data|safe }};
    
    Plotly.newPlot('sankeyChart_{{ forloop.counter }}', [sankeyData_{{ forloop.counter }}]);
    {% endfor %}
    {% endif %}

    {% if combination_counts %}
    // 공연 조합별 관객 분포 차트
    const ctxCombination = document.getElementById('combinationChart').getContext('2d');
    
    const combinationLabels = [
        {% for combo in combination_counts.keys %}
            '{{ combo }}',
        {% endfor %}
    ];
    const combinationData = [
        {% for count in combination_counts.values %}
            {{ count }},
        {% endfor %}
    ];

    const backgroundColors = [];
    const borderColors = [];

    for (let i = 0; i < combinationLabels.length; i++) {
        const hue = (i * 137.508) % 360;
        const bgColor = `hsl(${hue}, 50%, 90%)`;  
        const bdColor = `hsl(${hue}, 50%, 70%)`;
        backgroundColors.push(bgColor);
        borderColors.push(bdColor);
    }

    const dataCombinationChart = {
        labels: combinationLabels,
        datasets: [{
            data: combinationData,
            backgroundColor: backgroundColors,
            borderColor: borderColors,
            borderWidth: 1
        }]
    };

    const optionsCombinationChart = {
        responsive: true,
        plugins: {
            legend: {
                position: 'top',
            },
            title: {
                display: true,
                text: '공연 조합별 관객 분포'
            },
            tooltip: {
                callbacks: {
                    label: function(context) {
                        const label = context.label || '';
                        const value = context.raw || 0;
                        return `${label}: ${value}명`;
                    }
                }
            }
        }
    };

    new Chart(ctxCombination, {
        type: 'pie',
        data: dataCombinationChart,
        options: optionsCombinationChart
    });
    {% endif %}
});
</script>
{% endblock scripts %}
