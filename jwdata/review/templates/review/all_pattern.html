{% extends "review/base.html" %}
{% load static %}

{% block content %}
<div class="container-fluid py-4" style="min-height: 100vh;">
    <div class="content-container">

        <!-- 페이지 제목 -->
        <h1 class="text-center mb-5">공연 관람 패턴 분석</h1>

        {% if combination_counts %}
        <div class="mt-5">
            <h2>공연 조합별 관객 분포</h2>
            <div class="card p-3">
                <!-- 파이 차트를 표시할 캔버스 -->
                <canvas id="combinationChart" style="max-width: 100%; max-height: 500px;"></canvas>
            </div>
        </div>
        {% else %}
        <p class="text-muted mt-5">공연 조합별 관객 데이터가 없습니다.</p>
        {% endif %}

        <!-- 각 공연별 첫 공연 샌키 다이어그램 -->
        {% if all_concerts and filtered_common_nicknames %}
        {% for concert_name, sankey_data in filtered_common_nicknames.items %}
        <div class="mt-5">
            <h2>{{ concert_name }}을 첫 공연으로 한 관람 패턴</h2>
            <div class="card p-3">
                <div id="sankeyChart_{{ forloop.counter }}" class="sankey-chart" style="width: 100%; height: 600px;"></div>
            </div>
        </div>
        {% endfor %}
        {% else %}
        <p class="text-muted mt-5">데이터가 없습니다.</p>
        {% endif %}

        <!-- 샌키 다이어그램 -->
        {% if common_nicknames %}
        <div class="mt-5">
            <h2>모든 공연의 관람 패턴</h2>
            <div class="card p-3">
                <div id="sankeyChart" class="sankey-chart" style="width: 100%; height: 600px;"></div>
            </div>
        </div>
        {% else %}
        <p class="text-muted mt-5">데이터가 없습니다.</p>
        {% endif %}

        {% if common_nicknames %}
        <div class="mt-5">
            <h2>닉네임 별 관람 패턴</h2>
            <table class="table table-bordered table-hover mt-3">
                <thead class="table-dark">
                    <tr>
                        <th>닉네임</th>
                        <th>관람 공연</th>
                        <th>관람 공연 수</th>
                    </tr>
                </thead>
                <tbody>
                    {% for nickname, concerts in common_nicknames.items %}
                    <tr>
                        <td>{{ nickname }}</td>
                        <td>
                            {% for c in concerts %}
                                {{ c.concert }}({{ c.date }})
                                {% if not forloop.last %} → {% endif %}
                            {% endfor %}
                        </td>
                        <td>{{ concerts|length }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <p class="text-muted mt-5">닉네임 별 관람 패턴 데이터가 없습니다.</p>
        {% endif %}
    </div>
</div>
{% endblock content %}

{% block scripts %}
<!-- Chart.js 라이브러리 로드 -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<!-- Plotly.js 라이브러리 로드 -->
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        // 공연 이름별 고유 색상 생성
        const allConcertNames = [
            {% for concert_name in all_concerts %}
            '{{ concert_name }}',
            {% endfor %}
        ];
    
        // 고유 색상을 모든 차트에서 공유
        const concertColors = {};
        const backgroundColors = []; // 파이 차트를 위한 색상
        const borderColors = []; // 파이 차트의 테두리 색상
    
        allConcertNames.forEach((concert, index) => {
            const hue = (index * 137.508) % 360; // 황금각 기반 색상 분산
            const bgColor = `hsl(${hue}, 50%, 90%)`;
            const bdColor = `hsl(${hue}, 50%, 70%)`;
            concertColors[concert] = bgColor; // 샌키 다이어그램에서 사용할 색상
            backgroundColors.push(bgColor); // 파이 차트의 배경색
            borderColors.push(bdColor); // 파이 차트의 테두리 색상
        });
    
        function createSankeyData(data, colors) {
            const nodeColors = data.node.label.map(label => colors[label] || '#cccccc');
            data.node.color = nodeColors;
            return data;
        }
    
        function applyLinkColors(sankeyData) {
            const linkColors = sankeyData.link.source.map(sourceIndex => sankeyData.node.color[sourceIndex]);
            sankeyData.link.color = linkColors;
            return sankeyData;
        }
    
        // 공연별 샌키 다이어그램
        {% if filtered_common_nicknames %}
        {% for concert_name, sankey_data in filtered_common_nicknames.items %}
        const sankeyData_{{ forloop.counter }} = applyLinkColors(createSankeyData({{ sankey_data|safe }}, concertColors));

        // 노드와 링크에 호버 텍스트 설정
        sankeyData_{{ forloop.counter }}.node.hovertemplate = '%{label}<br>총 연결 수: %{value}<extra></extra>';
        sankeyData_{{ forloop.counter }}.link.hovertemplate = '출발: %{source.label}<br>도착: %{target.label}<extra></extra>';
        
        Plotly.react('sankeyChart_{{ forloop.counter }}', [sankeyData_{{ forloop.counter }}]);
    
        window.addEventListener('resize', function () {
            Plotly.Plots.resize('sankeyChart_{{ forloop.counter }}');
        });
        {% endfor %}
        {% endif %}
    
        // 모든 공연 샌키 다이어그램
        {% if common_nicknames %}
        const sankeyData = createSankeyData({
            type: 'sankey',
            orientation: 'h',
            node: {
                pad: 15,
                thickness: 20,
                line: { color: 'black', width: 0.5 },
                label: [
                    {% for nickname, concerts in common_nicknames.items %}
                        {% for concert in concerts %}
                            '{{ concert.concert }}',
                        {% endfor %}
                    {% endfor %}
                ],
            },
            link: { source: [], target: [], value: [] },
        }, concertColors);
    
        const nodeIndex = {};
        let index = 0;
        for (const [nickname, concerts] of Object.entries({{ common_nicknames|safe }})) {
            for (let i = 0; i < concerts.length - 1; i++) {
                const source = concerts[i].concert;
                const target = concerts[i + 1].concert;
    
                if (!(source in nodeIndex)) nodeIndex[source] = index++;
                if (!(target in nodeIndex)) nodeIndex[target] = index++;
    
                sankeyData.link.source.push(nodeIndex[source]);
                sankeyData.link.target.push(nodeIndex[target]);
                sankeyData.link.value.push(1);
            }
        }

        // 노드와 링크에 호버 텍스트 설정
        sankeyData.node.hovertemplate = '%{label}<br>총 연결 수: %{value}<extra></extra>';
        sankeyData.link.hovertemplate = '출발: %{source.label}<br>도착: %{target.label}<extra></extra>';
    
        Plotly.react('sankeyChart', [sankeyData]);
    
        window.addEventListener('resize', function () {
            Plotly.Plots.resize('sankeyChart');
        });
        {% endif %}
    
        {% if combination_counts %}
        // 공연 조합별 관객 분포 차트
        const ctxCombination = document.getElementById('combinationChart').getContext('2d');
    
        const combinationLabels = [
            {% for combo in combination_counts.keys %}
                '{{ combo }}',
            {% endfor %}
        ];
        const combinationData = [
            {% for count in combination_counts.values %}
                {{ count }},
            {% endfor %}
        ];
    
        const dataCombinationChart = {
            labels: combinationLabels,
            datasets: [{
                data: combinationData,
                backgroundColor: backgroundColors,
                borderColor: borderColors,
                borderWidth: 1
            }]
        };
    
        const optionsCombinationChart = {
            responsive: true,
            plugins: {
                legend: {
                    position: 'top',
                },
                title: {
                    display: true,
                    text: '공연 조합별 관객 분포'
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const label = context.label || '';
                            const value = context.raw || 0;
                            return `${label}: ${value}명`;
                        }
                    }
                }
            }
        };
    
        new Chart(ctxCombination, {
            type: 'pie',
            data: dataCombinationChart,
            options: optionsCombinationChart
        });
        {% endif %}
    });    
</script>
{% endblock scripts %}
